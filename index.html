<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RootSage Plant Identifier (PWA)</title>
    <!-- PWA Requirements: Define how the app should look on a home screen -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="theme-color" content="#10b981">
    
    <!-- Load Tailwind CSS, React, ReactDOM, and Babel -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel is needed to compile JSX in the browser for this single-file setup -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Load Lucide Icons UMD Bundle -->
    <script src="https://unpkg.com/lucide-react@latest/dist/umd/lucide-react.js"></script>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged, 
            GoogleAuthProvider, 
            signInWithPopup,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            collection, 
            setDoc, 
            getDoc, 
            onSnapshot,
            serverTimestamp,
            getDocs,
            query,
            where
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";


        // --- SECURITY FIX: Use Placeholder for GitHub Actions Injection ---
        // The GitHub Action (deploy.yml) will replace $$FIREBASE_API_KEY$$ with the secret value during build.
        const SECURE_FIREBASE_CONFIG = {
            apiKey: "$$FIREBASE_API_KEY$$",
            authDomain: "rootsagev2.firebaseapp.com",
            projectId: "rootsagev2",
            storageBucket: "rootsagev2.firebasestorage.app",
            messagingSenderId: "355755573557",
            appId: "1:355755573557:web:5e23d0587264097934cc7c"
        };
        // ------------------------------------------------------------------

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Initialize Firebase
        const firebaseApp = initializeApp(SECURE_FIREBASE_CONFIG);
        const db = getFirestore(firebaseApp);
        const auth = getAuth(firebaseApp);
        
        // Expose Firebase functions to the global window object for use in the Babel script
        window.firebaseApp = firebaseApp;
        window.db = db;
        window.auth = auth;
        window.onAuthStateChanged = onAuthStateChanged;
        window.signInWithPopup = signInWithPopup;
        window.GoogleAuthProvider = GoogleAuthProvider;
        window.signOut = signOut;
        window.collection = collection;
        window.doc = doc;
        window.setDoc = setDoc;
        window.getDoc = getDoc;
        window.onSnapshot = onSnapshot;
        window.serverTimestamp = serverTimestamp;
        window.getDocs = getDocs;
        window.query = query;
        window.where = where;

        // Ensure logging is set for better debugging visibility
        setLogLevel('Debug');
    </script>


    <!-- Custom CSS for mobile-first PWA feel -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }
        #root {
            width: 100%;
            max-width: 600px; /* Max width for a clean mobile container */
            height: 100vh;
            background-color: white;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }
        /* Style the modal overlay */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(2px);
        }
        /* Hide scrollbar for cleaner look */
        .overflow-y-auto::-webkit-scrollbar {
            display: none;
        }
        .overflow-y-auto {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // Ensure Lucide icons are available from the global context
        const { 
            Leaf: IconLeaf, 
            Camera: IconCamera, 
            BookOpen: IconBookOpen, 
            GalleryVertical: IconGalleryVertical, 
            User: IconUser, 
            AlertTriangle: IconAlertTriangle,
            UploadCloud: IconUploadCloud,
            X: IconX,
            CheckCircle: IconCheckCircle,
            Home: IconHome,
            Trash2: IconTrash2,
            Share2: IconShare2,
            RefreshCw: IconRefreshCw,
            Crown: IconCrown
        } = lucide;

        const { useState, useEffect, useCallback } = React;

        // --- ENUMS AND CONSTANTS ---

        const PAGES = {
            SPLASH: 'splash',
            STEWARDSHIP: 'stewardship',
            CAMERA: 'camera',
            IDENTIFICATION: 'identification',
            COLLECTIONS: 'collections',
            PROFILE: 'profile',
            COMMUNITY: 'community' // Future community feed
        };

        const RANKS = {
            SEEDLING: { score: 0, name: "Seedling", color: "text-gray-500", icon: "ðŸŒ±" },
            APPRENTICE: { score: 10, name: "Apprentice Sprout", color: "text-green-500", icon: "ðŸŒ¿" },
            JOURNEYMAN: { score: 50, name: "Journeyman Arborist", color: "text-blue-500", icon: "ðŸŒ³" },
            MASTER: { score: 150, name: "Master Root Sage", color: "text-yellow-500", icon: "ðŸ‘‘" }
        };

        const INITIAL_USER_DATA = {
            displayName: "Anonymous User",
            score: 0,
            collections: 0,
            lastActivity: null,
        };

        const USER_DATA_PATH = `/artifacts/${appId}/users`;
        const PUBLIC_COLLECTION_PATH = `/artifacts/${appId}/public/data/collections`;


        // --- FIREBASE HOOKS ---

        const useAuth = () => {
            const [user, setUser] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [dbInstance, setDbInstance] = useState(null);
            const [authInstance, setAuthInstance] = useState(null);
            const [authProvider, setAuthProvider] = useState(null);

            useEffect(() => {
                if (window.auth && window.db && window.GoogleAuthProvider) {
                    setAuthInstance(window.auth);
                    setDbInstance(window.db);
                    setAuthProvider(new window.GoogleAuthProvider());
                    
                    // Listen for authentication state changes
                    const unsubscribe = window.onAuthStateChanged(window.auth, (currentUser) => {
                        if (currentUser) {
                            setUser(currentUser);
                        } else {
                            setUser(null);
                        }
                        setIsAuthReady(true);
                    });

                    return () => unsubscribe();
                } else {
                    console.error("Firebase instances not globally available.");
                    setIsAuthReady(true); 
                }
            }, []);

            const signInWithGoogle = useCallback(async () => {
                if (!authInstance || !authProvider) return;
                try {
                    await window.signInWithPopup(authInstance, authProvider);
                } catch (error) {
                    console.error("Google Sign-In failed:", error);
                }
            }, [authInstance, authProvider]);

            const signOutUser = useCallback(async () => {
                if (!authInstance) return;
                try {
                    await window.signOut(authInstance);
                    setUser(null);
                } catch (error) {
                    console.error("Sign-out failed:", error);
                }
            }, [authInstance]);

            return { user, isAuthReady, dbInstance, signInWithGoogle, signOutUser, userId: user?.uid };
        };

        const useUserData = (userId, dbInstance, isAuthReady) => {
            const [data, setData] = useState(null);
            
            useEffect(() => {
                if (!isAuthReady || !dbInstance || !userId) {
                    setData(INITIAL_USER_DATA);
                    return;
                }

                const userDocRef = window.doc(dbInstance, USER_DATA_PATH, userId);
                
                // Real-time listener for user data
                const unsubscribe = window.onSnapshot(userDocRef, async (docSnapshot) => {
                    if (docSnapshot.exists()) {
                        // User data exists, update state
                        setData(docSnapshot.data());
                    } else {
                        // User data doesn't exist, create it
                        const newUserData = {
                            ...INITIAL_USER_DATA,
                            displayName: window.auth.currentUser?.displayName || "Anonymous User",
                            createdAt: window.serverTimestamp(),
                            userId: userId,
                        };
                        try {
                            await window.setDoc(userDocRef, newUserData);
                            setData(newUserData);
                        } catch (e) {
                            console.error("Error creating user document:", e);
                            setData(INITIAL_USER_DATA);
                        }
                    }
                }, (error) => {
                    console.error("Error listening to user data:", error);
                    setData(INITIAL_USER_DATA);
                });

                return () => unsubscribe();
            }, [userId, dbInstance, isAuthReady]);

            // Function to update the user's score
            const updateScore = useCallback(async (points) => {
                if (!dbInstance || !userId) return;
                const userDocRef = window.doc(dbInstance, USER_DATA_PATH, userId);
                try {
                    await window.setDoc(userDocRef, { 
                        score: (data?.score || 0) + points,
                        lastActivity: window.serverTimestamp()
                    }, { merge: true });
                } catch (e) {
                    console.error("Error updating score:", e);
                }
            }, [dbInstance, userId, data]);

            return { userData: data, updateScore };
        };

        const useCollections = (dbInstance, isAuthReady, userId) => {
            const [collections, setCollections] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (!isAuthReady || !dbInstance || !userId) {
                    setCollections([]);
                    setLoading(false);
                    return;
                }
                
                // Path to the user's private collection
                const userCollectionsRef = window.collection(dbInstance, USER_DATA_PATH, userId, 'my_plants');

                const unsubscribe = window.onSnapshot(userCollectionsRef, (snapshot) => {
                    const list = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setCollections(list);
                    setLoading(false);
                }, (error) => {
                    console.error("Error fetching collections:", error);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [dbInstance, isAuthReady, userId]);

            // Function to add a plant to the collection
            const addPlantToCollection = useCallback(async (plantData) => {
                if (!dbInstance || !userId) {
                    return { success: false, message: "Authentication required to save." };
                }

                const userCollectionsRef = window.collection(dbInstance, USER_DATA_PATH, userId, 'my_plants');
                
                try {
                    const newDocRef = window.doc(userCollectionsRef);
                    await window.setDoc(newDocRef, {
                        ...plantData,
                        collectedAt: window.serverTimestamp(),
                        userId: userId,
                    });
                    
                    // Update user's count immediately (handled by useUserData listener but useful for immediate feedback)
                    // You might merge this with a single updateScore call in a real app
                    // updateScore(0); 

                    return { success: true, message: "Plant added to collection!" };
                } catch (e) {
                    console.error("Error adding plant to collection:", e);
                    return { success: false, message: "Failed to add plant to collection." };
                }
            }, [dbInstance, userId]);

            return { collections, loading, addPlantToCollection };
        };


        // --- COMPONENTS ---

        const Modal = ({ title, children, onClose }) => (
            <div className="modal-overlay fixed inset-0 z-50 flex items-center justify-center p-4">
                <div className="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 transform transition-all duration-300 scale-100">
                    <div className="flex justify-between items-center border-b pb-3 mb-4">
                        <h3 className="text-xl font-bold text-gray-800">{title}</h3>
                        <button onClick={onClose} className="text-gray-400 hover:text-gray-600">
                            <IconX className="w-6 h-6" />
                        </button>
                    </div>
                    {children}
                </div>
            </div>
        );

        const StewardshipPage = ({ setCurrentPage }) => (
            <div className="p-6 h-full flex flex-col justify-between">
                <div>
                    <h1 className="text-4xl font-extrabold text-green-700 mb-4 flex items-center">
                        <IconLeaf className="w-8 h-8 mr-2" /> RootSage
                    </h1>
                    <h2 className="text-2xl font-semibold text-gray-800 mb-6">Our Stewardship Code of Conduct</h2>
                    
                    <p className="text-gray-600 mb-4">
                        By using RootSage, you agree to uphold our community values for plant identification and protection:
                    </p>

                    <ul className="space-y-4 text-gray-700">
                        <li className="flex items-start">
                            <IconCheckCircle className="w-5 h-5 text-green-500 mt-1 mr-3 flex-shrink-0" />
                            <div>
                                <strong className="block text-green-700">Respect Wildlife & Habitat:</strong> Never trespass or harm natural environments to obtain a photo.
                            </div>
                        </li>
                        <li className="flex items-start">
                            <IconCheckCircle className="w-5 h-5 text-green-500 mt-1 mr-3 flex-shrink-0" />
                            <div>
                                <strong className="block text-green-700">Avoid Picking or Damaging:</strong> Take photos without touching, picking, or altering the plant in its environment.
                            </div>
                        </li>
                        <li className="flex items-start">
                            <IconCheckCircle className="w-5 h-5 text-green-500 mt-1 mr-3 flex-shrink-0" />
                            <div>
                                <strong className="block text-green-700">Accuracy & Integrity:</strong> Strive for clear photos to ensure accurate identification and reliable community verification.
                            </div>
                        </li>
                    </ul>
                </div>
                
                <button
                    onClick={() => setCurrentPage(PAGES.CAMERA)}
                    className="w-full py-3 bg-green-600 text-white font-bold rounded-xl shadow-lg hover:bg-green-700 transition transform hover:scale-[1.01] active:scale-[0.99] mt-8"
                >
                    Agree & Start Identifying
                </button>
            </div>
        );
        
        const CameraPage = ({ setCurrentPage, setScanResult, updateScore }) => {
            const [selectedImages, setSelectedImages] = useState([]);
            const [isLoading, setIsLoading] = useState(false);
            const MAX_IMAGES = 3;

            const handleImageChange = (event) => {
                const files = Array.from(event.target.files).slice(0, MAX_IMAGES - selectedImages.length);
                const newImages = files.map(file => ({
                    url: URL.createObjectURL(file),
                    file: file,
                    name: file.name
                }));
                setSelectedImages(prev => [...prev, ...newImages]);
            };

            const removeImage = (index) => {
                setSelectedImages(prev => prev.filter((_, i) => i !== index));
            };

            const handleScan = () => {
                if (selectedImages.length === 0) return;

                setIsLoading(true);

                // --- MOCK IDENTIFICATION LOGIC (Echinacea Fix) ---
                setTimeout(() => {
                    const mockResult = {
                        name: "Echinacea Purpurea",
                        commonName: "Purple Coneflower",
                        confidence: 95,
                        description: "A popular perennial known for its large, brightly colored flowers and medicinal properties. It is native to eastern North America.",
                        toxicity: "Generally considered non-toxic, but high doses may cause temporary stomach upset.",
                        imageUrl: "https://placehold.co/400x300/10B981/FFFFFF?text=Echinacea"
                    };

                    setScanResult(mockResult);
                    setCurrentPage(PAGES.IDENTIFICATION);
                    
                    // Simulate points for successful identification
                    updateScore(5);

                    setIsLoading(false);
                    setSelectedImages([]); // Clear images after successful scan
                }, 1500); 
            };

            return (
                <div className="p-6">
                    <h2 className="text-2xl font-bold text-gray-800 mb-6">Identify a Plant</h2>
                    
                    <div className="space-y-4 mb-6">
                        {selectedImages.map((image, index) => (
                            <div key={index} className="flex items-center justify-between p-3 bg-gray-50 rounded-xl border border-gray-200">
                                <div className="flex items-center space-x-3">
                                    <img src={image.url} alt={`Preview ${index + 1}`} className="w-12 h-12 object-cover rounded-lg" />
                                    <span className="text-sm text-gray-600 truncate">{image.name}</span>
                                </div>
                                <button 
                                    onClick={() => removeImage(index)}
                                    className="text-red-500 hover:text-red-700 p-1 rounded-full bg-white transition duration-150"
                                >
                                    <IconX className="w-4 h-4" />
                                </button>
                            </div>
                        ))}
                    </div>

                    {selectedImages.length < MAX_IMAGES && (
                        <label 
                            htmlFor="image-upload"
                            className="flex flex-col items-center justify-center p-6 border-2 border-dashed border-green-300 text-green-700 bg-green-50 rounded-xl cursor-pointer hover:bg-green-100 transition duration-300"
                        >
                            <IconUploadCloud className="w-8 h-8 mb-2" />
                            <span className="font-semibold">Upload Image ({selectedImages.length}/{MAX_IMAGES})</span>
                            <span className="text-xs text-green-500 mt-1">For best results, upload 1-3 photos (leaf, flower, whole plant).</span>
                            <input
                                id="image-upload"
                                type="file"
                                accept="image/*"
                                multiple
                                onChange={handleImageChange}
                                className="hidden"
                                disabled={selectedImages.length >= MAX_IMAGES}
                            />
                        </label>
                    )}

                    <button
                        onClick={handleScan}
                        disabled={selectedImages.length === 0 || isLoading}
                        className={`w-full py-4 mt-8 font-bold rounded-xl shadow-lg transition duration-300 ${
                            selectedImages.length > 0 && !isLoading 
                                ? 'bg-green-600 text-white hover:bg-green-700 transform hover:scale-[1.01]' 
                                : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                        }`}
                    >
                        {isLoading ? (
                            <div className="flex justify-center items-center">
                                <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                Analyzing...
                            </div>
                        ) : 'Identify Plant'}
                    </button>
                    
                    <button
                        onClick={() => setCurrentPage(PAGES.COMMUNITY)}
                        className="w-full py-2 mt-4 text-green-600 font-semibold rounded-xl hover:bg-green-50 transition duration-300"
                    >
                        Community Verification (Coming Soon)
                    </button>
                </div>
            );
        };

        const IdentificationPage = ({ scanResult, setCurrentPage, addPlantToCollection }) => {
            const [showModal, setShowModal] = useState(false);

            if (!scanResult) {
                return <div className="p-6 text-center text-gray-500">No scan result available.</div>;
            }

            const plantData = {
                name: scanResult.name,
                commonName: scanResult.commonName,
                confidence: scanResult.confidence,
            };

            const handleAddToCollection = async () => {
                const response = await addPlantToCollection(plantData);
                if (response.success) {
                    setShowModal(true);
                    setTimeout(() => setShowModal(false), 2000);
                } else {
                    alert(response.message); // Use alert for critical auth error
                }
            };
            
            const handleRetake = () => {
                setCurrentPage(PAGES.CAMERA);
            };

            return (
                <div className="p-6">
                    <div className="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-100">
                        <img src={scanResult.imageUrl} alt={scanResult.commonName} className="w-full h-48 object-cover" onError={(e) => e.target.src='https://placehold.co/400x300/ccc/333?text=Plant+Image'} />
                        
                        <div className="p-5">
                            <h3 className="text-sm font-semibold text-green-600">Identification Result</h3>
                            <h1 className="text-3xl font-extrabold text-gray-900 mt-1 mb-2">{scanResult.commonName}</h1>
                            <p className="text-lg italic text-gray-600 mb-4">{scanResult.name}</p>

                            <div className="flex items-center mb-6 p-3 bg-green-50 rounded-lg">
                                <IconCheckCircle className="w-5 h-5 text-green-600 mr-2 flex-shrink-0" />
                                <span className="font-semibold text-green-700">Confidence: {scanResult.confidence}%</span>
                            </div>

                            <h4 className="text-lg font-semibold text-gray-800 mb-2">Description</h4>
                            <p className="text-gray-600 mb-6">{scanResult.description}</p>
                            
                            <h4 className="text-lg font-semibold text-gray-800 mb-2">Toxicity Warning</h4>
                            <div className="flex items-start mb-6 p-3 bg-yellow-50 rounded-lg border border-yellow-200">
                                <IconAlertTriangle className="w-5 h-5 text-yellow-600 mr-2 flex-shrink-0 mt-1" />
                                <p className="text-yellow-800 text-sm">
                                    {scanResult.toxicity}
                                </p>
                            </div>

                            <div className="flex space-x-3">
                                <button
                                    onClick={handleAddToCollection}
                                    className="flex-1 flex items-center justify-center py-3 bg-blue-600 text-white font-semibold rounded-xl shadow-md hover:bg-blue-700 transition transform hover:scale-[1.02] active:scale-[0.98]"
                                >
                                    <IconGalleryVertical className="w-5 h-5 mr-2" /> Add to Collection
                                </button>
                                <button
                                    onClick={handleRetake}
                                    className="w-1/3 flex items-center justify-center py-3 bg-gray-200 text-gray-700 font-semibold rounded-xl shadow-md hover:bg-gray-300 transition transform hover:scale-[1.02] active:scale-[0.98]"
                                >
                                    <IconRefreshCw className="w-5 h-5" /> Retake
                                </button>
                            </div>
                            
                            
                        </div>
                    </div>
                    {showModal && (
                        <Modal title="Success!" onClose={() => setShowModal(false)}>
                            <p className="text-gray-700">'{scanResult.commonName}' has been added to your personal collection!</p>
                        </Modal>
                    )}
                </div>
            );
        };

        const CollectionsPage = ({ collections, loading }) => {
            if (!loading && collections.length === 0) {
                return (
                    <div className="p-6 text-center pt-20">
                        <IconBookOpen className="w-16 h-16 text-gray-300 mx-auto mb-4" />
                        <h2 className="text-xl font-semibold text-gray-700 mb-2">Your Collection is Empty</h2>
                        <p className="text-gray-500">Identify a plant using the camera to start saving your finds!</p>
                    </div>
                );
            }

            return (
                <div className="p-6">
                    <h2 className="text-2xl font-bold text-gray-800 mb-6">My Plant Collections ({collections.length})</h2>
                    {loading ? (
                        <div className="text-center text-gray-500">Loading your treasures...</div>
                    ) : (
                        <div className="space-y-4">
                            {collections.map((plant) => (
                                <div key={plant.id} className="p-4 bg-white rounded-xl shadow-md border border-gray-100 flex justify-between items-center">
                                    <div>
                                        <h3 className="text-lg font-semibold text-green-700">{plant.commonName}</h3>
                                        <p className="text-sm italic text-gray-500">{plant.name}</p>
                                        <p className="text-xs text-gray-400 mt-1">
                                            Confidence: {plant.confidence}%
                                        </p>
                                    </div>
                                    <IconTrash2 className="w-5 h-5 text-red-400 hover:text-red-600 cursor-pointer" title="Remove from Collection" />
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };
        
        const getRank = (score) => {
            if (score >= RANKS.MASTER.score) return RANKS.MASTER;
            if (score >= RANKS.JOURNEYMAN.score) return RANKS.JOURNEYMAN;
            if (score >= RANKS.APPRENTICE.score) return RANKS.APPRENTICE;
            return RANKS.SEEDLING;
        };

        const ProfilePage = ({ userData, signInWithGoogle, signOutUser, user, isAuthReady }) => {
            const currentRank = getRank(userData?.score || 0);
            
            // Calculate progress to the next rank
            const nextRankKey = Object.keys(RANKS).find(key => RANKS[key].score > currentRank.score);
            const nextRank = nextRankKey ? RANKS[nextRankKey] : RANKS.MASTER;

            const progress = currentRank === RANKS.MASTER 
                ? 100 
                : ((userData?.score || 0) - currentRank.score) / (nextRank.score - currentRank.score) * 100;

            const currentScore = userData?.score || 0;
            const targetScore = nextRank.score;
            
            return (
                <div className="p-6">
                    <h2 className="text-3xl font-bold text-gray-800 mb-6 flex items-center">
                        <IconUser className="w-7 h-7 mr-2 text-green-600" /> My Profile
                    </h2>

                    <div className="mb-8 p-6 bg-white rounded-2xl shadow-lg border border-gray-100">
                        <div className="flex items-center space-x-4 mb-4">
                            <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center text-2xl border-2 border-green-500">
                                {currentRank.icon}
                            </div>
                            <div>
                                <h3 className="text-xl font-bold text-gray-900">{userData?.displayName}</h3>
                                {user ? (
                                    <p className="text-xs text-gray-500 truncate">UID: {user.uid}</p>
                                ) : (
                                    <p className="text-xs text-red-500">Not signed in.</p>
                                )}
                            </div>
                        </div>

                        <div className="mt-4">
                            <h4 className="text-sm font-semibold text-gray-700">Current Rank: <span className={`${currentRank.color} text-base`}>{currentRank.name}</span></h4>
                            <h4 className="text-sm font-semibold text-gray-700 mt-1">Total Identification Points: <span className="text-lg text-green-600">{currentScore}</span></h4>
                        </div>
                    </div>
                    
                    {/* Gamification Tracker */}
                    <div className="mb-8 p-6 bg-white rounded-2xl shadow-lg border border-gray-100">
                        <h4 className="text-xl font-bold text-gray-800 mb-3 flex items-center">
                            <IconCrown className="w-5 h-5 mr-2 text-yellow-500" /> RootSage Mastery Level
                        </h4>
                        
                        <p className="text-sm text-gray-600 mb-2">
                            {currentRank === RANKS.MASTER 
                                ? "You have achieved Master Root Sage status!" 
                                : `Next Goal: ${nextRank.name} at ${targetScore} points.`}
                        </p>

                        <div className="w-full bg-gray-200 rounded-full h-3.5 mb-2">
                            <div 
                                className="bg-green-600 h-3.5 rounded-full transition-all duration-500" 
                                style={{ width: `${progress}%` }}
                            ></div>
                        </div>
                        
                        <div className="flex justify-between text-xs text-gray-500">
                            <span>{currentRank.name}</span>
                            <span>{currentScore}/{targetScore} points</span>
                            {currentRank !== RANKS.MASTER && <span>{nextRank.name}</span>}
                        </div>
                    </div>


                    {/* Auth Actions */}
                    <div className="mt-8">
                        {user ? (
                            <button
                                onClick={signOutUser}
                                className="w-full py-3 bg-red-600 text-white font-bold rounded-xl shadow-lg hover:bg-red-700 transition transform hover:scale-[1.01] active:scale-[0.99]"
                                disabled={!isAuthReady}
                            >
                                Sign Out ({user.displayName || user.email})
                            </button>
                        ) : (
                            <button
                                onClick={signInWithGoogle}
                                className="w-full py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg hover:bg-blue-700 transition transform hover:scale-[1.01] active:scale-[0.99] flex items-center justify-center"
                                disabled={!isAuthReady}
                            >
                                <svg className="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 48 48">
                                    <path d="M44.5 20H24v8.5h11.8c-.7 4.5-4.8 7.2-9.8 7.2-6.5 0-11.8-5.3-11.8-11.8s5.3-11.8 11.8-11.8c3.2 0 6.2 1.3 8.3 3.4l6-6c-3.6-3.4-8.7-5.4-14.3-5.4-11.8 0-21.5 9.7-21.5 21.5s9.7 21.5 21.5 21.5c11.3 0 19.8-8 19.8-19.8 0-1.3-.2-2.7-.4-4z" clipRule="evenodd"/><path fill="#34A853" d="M10.8 24c0-2.4.4-4.7 1.2-6.8l-5.6-4.3c-2.3 4.8-3.6 10.2-3.6 15.6 0 5.4 1.3 10.8 3.6 15.6l5.6-4.3c-.8-2.1-1.2-4.4-1.2-6.8z"/><path fill="#4285F4" d="M44.5 20H24v8.5h11.8c-.7 4.5-4.8 7.2-9.8 7.2-6.5 0-11.8-5.3-11.8-11.8s5.3-11.8 11.8-11.8c3.2 0 6.2 1.3 8.3 3.4l6-6c-3.6-3.4-8.7-5.4-14.3-5.4-11.8 0-21.5 9.7-21.5 21.5s9.7 21.5 21.5 21.5c11.3 0 19.8-8 19.8-19.8 0-1.3-.2-2.7-.4-4z" clipRule="evenodd"/><path fill="#FBBC04" d="M12 30.5c0-1.6.3-3.2.8-4.7l-5.6-4.3c-1.2 2.5-1.9 5.3-1.9 8.2 0 2.9.7 5.7 1.9 8.2l5.6-4.3c-.5-1.5-.8-3.1-.8-4.7z"/><path fill="#EA4335" d="M24 6c3.2 0 6.2 1.3 8.3 3.4l6-6c-3.6-3.4-8.7-5.4-14.3-5.4C12.2 0 2.5 9.7 2.5 21.5h10.3c0-6.5 5.3-11.8 11.2-11.8z"/>
                                </svg>
                                Sign In with Google
                            </button>
                        )}
                    </div>
                </div>
            );
        };
        
        const CommunityPage = () => (
            <div className="p-6 text-center pt-20">
                <IconShare2 className="w-16 h-16 text-gray-300 mx-auto mb-4" />
                <h2 className="text-2xl font-semibold text-gray-700 mb-2">Community Verification</h2>
                <p className="text-gray-500">
                    This feature is coming soon! You will be able to submit your plant identifications for review by other Master Root Sages.
                </p>
            </div>
        );


        const NavBar = ({ currentPage, setCurrentPage }) => {
            const tabs = [
                { page: PAGES.CAMERA, icon: IconCamera, label: 'Identify' },
                { page: PAGES.COLLECTIONS, icon: IconGalleryVertical, label: 'Collections' },
                { page: PAGES.COMMUNITY, icon: IconBookOpen, label: 'Community' },
                { page: PAGES.PROFILE, icon: IconUser, label: 'Profile' },
            ];

            return (
                <nav className="fixed bottom-0 left-0 right-0 max-w-lg mx-auto bg-white border-t border-gray-200 shadow-xl z-20">
                    <div className="flex justify-around h-16">
                        {tabs.map(({ page, icon: Icon, label }) => (
                            <button
                                key={page}
                                onClick={() => setCurrentPage(page)}
                                className={`flex flex-col items-center justify-center p-2 text-sm transition duration-150 ${
                                    currentPage === page 
                                        ? 'text-green-600 font-bold border-t-2 border-green-600 -mt-px'
                                        : 'text-gray-500 hover:text-green-500'
                                }`}
                            >
                                <Icon className="w-6 h-6" />
                                <span className="text-xs mt-0.5">{label}</span>
                            </button>
                        ))}
                    </div>
                </nav>
            );
        };
        

        const App = () => {
            const [currentPage, setCurrentPage] = useState(PAGES.STEWARDSHIP);
            const [scanResult, setScanResult] = useState(null);

            // Auth and Firestore setup
            const { user, isAuthReady, dbInstance, signInWithGoogle, signOutUser, userId } = useAuth();
            
            // Wait for auth to be ready before fetching user data
            const { userData, updateScore } = useUserData(userId, dbInstance, isAuthReady);

            // Collections hook
            const { collections, loading: collectionsLoading, addPlantToCollection } = useCollections(dbInstance, isAuthReady, userId);

            // Simple state for first-time user splash screen after auth is ready
            useEffect(() => {
                if (isAuthReady && currentPage === PAGES.SPLASH) {
                    // Automatically move past splash once auth is checked
                    setCurrentPage(PAGES.STEWARDSHIP); 
                }
            }, [isAuthReady, currentPage]);


            const renderPage = () => {
                // Global Loading Screen while waiting for Auth to settle
                if (!isAuthReady) {
                    return (
                        <div className="flex flex-col items-center justify-center h-full text-gray-500">
                            <svg className="animate-spin h-8 w-8 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <p className="mt-4">Securing your connection...</p>
                        </div>
                    );
                }

                switch (currentPage) {
                    case PAGES.SPLASH:
                        return null; // Handled by useEffect
                    case PAGES.STEWARDSHIP:
                        return <StewardshipPage setCurrentPage={setCurrentPage} />;
                    case PAGES.CAMERA:
                        return <CameraPage setCurrentPage={setCurrentPage} setScanResult={setScanResult} updateScore={updateScore} />;
                    case PAGES.IDENTIFICATION:
                        return <IdentificationPage 
                            scanResult={scanResult} 
                            setCurrentPage={setCurrentPage} 
                            addPlantToCollection={addPlantToCollection} 
                        />;
                    case PAGES.COLLECTIONS:
                        return <CollectionsPage collections={collections} loading={collectionsLoading} />;
                    case PAGES.PROFILE:
                        return <ProfilePage 
                            userData={userData} 
                            signInWithGoogle={signInWithGoogle} 
                            signOutUser={signOutUser} 
                            user={user}
                            isAuthReady={isAuthReady}
                        />;
                    case PAGES.COMMUNITY:
                        return <CommunityPage />;
                    default:
                        return <CameraPage setCurrentPage={setCurrentPage} setScanResult={setScanResult} updateScore={updateScore} />;
                }
            };


            return (
                <div id="app-container" className="flex flex-col h-full">
                    {/* Main Content Area */}
                    <div className="flex flex-col h-full w-full max-w-lg mx-auto overflow-hidden">
                        {/* Header for non-splash/non-stewardship pages */}
                        {currentPage !== PAGES.SPLASH && currentPage !== PAGES.STEWARDSHIP && (
                            <header className="sticky top-0 bg-white p-4 border-b border-gray-200 flex items-center justify-between z-10">
                                <h1 className="text-xl font-bold text-green-700 flex items-center">
                                    <IconLeaf className="w-6 h-6 mr-1" /> RootSage
                                </h1>
                                <button 
                                    onClick={() => setCurrentPage(PAGES.PROFILE)}
                                    className="text-sm text-gray-500 hover:text-green-600 flex items-center"
                                >
                                    <IconUser className="w-4 h-4 mr-1"/> Profile
                                </button>
                            </header>
                        )}

                        <main className={`flex-grow overflow-y-auto ${currentPage !== PAGES.SPLASH && currentPage !== PAGES.STEWARDSHIP && 'mb-16'} ${currentPage === PAGES.SPLASH || currentPage === PAGES.STEWARDSHIP ? 'h-screen' : 'pb-16'}`}>
                            {renderPage()}
                        </main>

                        {currentPage !== PAGES.SPLASH && currentPage !== PAGES.STEWARDSHIP && <NavBar currentPage={currentPage} setCurrentPage={setCurrentPage} />}
                    </div>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);

        // --- End of RootSageApp.jsx code ---

        
    </script>
</body>
</html>
