<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RootSage Plant Identifier (PWA)</title>
    <!-- PWA Requirements: Define how the app should look on a home screen -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="theme-color" content="#10b981">
    
    <!-- Load Tailwind CSS, React, ReactDOM, and Babel -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel is needed to compile JSX in the browser for this single-file setup -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Configure Tailwind to use Inter font and necessary utility classes -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'sage-green': '#38a169',
                    },
                }
            }
        }
    </script>

    <!--
    Setup the global Firebase object.
    This script is crucial because it imports the ES modules and attaches the necessary functions
    to the 'window.firebase' object so the Babel script can use them.
    -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // Attach all required Firebase functions to the window object for use in the Babel script
        window.firebase = {
            initializeApp,
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged,
            signOut,
            getFirestore,
            doc,
            getDoc,
            addDoc,
            setDoc,
            updateDoc,
            deleteDoc,
            onSnapshot,
            collection,
            query,
            where,
            getDocs,
            setLogLevel,
            getStorage,
            ref,
            uploadBytes,
            getDownloadURL
        };

        // Enable debug logging for Firebase
        window.firebase.setLogLevel('Debug');
    </script>
</head>
<body class="font-sans bg-gray-50 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, createContext, useContext } = React;

        // --- Constants and Icons ---
        const PAGES = {
            SPLASH: 'splash',
            HOME: 'home',
            CAMERA: 'camera',
            HISTORY: 'history',
            PROFILE: 'profile',
            DISCLAIMER: 'disclaimer',
            RESULT: 'result',
        };

        const IconLeaf = (props) => (
            <svg {...props} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 20A7 7 0 0 1 9.8 6.1C15 6 18.2 8.4 20 14" /><path d="M12 21.3V17" /><path d="M15 16.6V13" /><path d="M18 19.3V16" /></svg>
        );
        const IconCamera = (props) => (
            <svg {...props} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>
        );
        const IconHome = (props) => (
            <svg {...props} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" /><polyline points="9 22 9 12 15 12 15 22" /></svg>
        );
        const IconHistory = (props) => (
            <svg {...props} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2v8l4-4" /><path d="M12 22v-8l-4 4" /><path d="M20 12h2" /><path d="M10 20.3a9 9 0 1 0 0-16.6" /></svg>
        );
        const IconUser = (props) => (
            <svg {...props} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" /></svg>
        );
        const IconX = (props) => (
            <svg {...props} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6L6 18"/><path d="M6 6l12 12"/></svg>
        );

        // --- Firebase Context and Hook ---
        const FirebaseContext = createContext(null);
        const useFirebase = () => {
            const context = useContext(FirebaseContext);
            if (!context) {
                throw new Error('useFirebase must be used within a FirebaseProvider');
            }
            return context;
        };

        // --- Components (Stubs for demonstration) ---

        const LoadingScreen = () => (
            <div className="flex flex-col items-center justify-center h-full bg-sage-green/10 p-8">
                <IconLeaf className="w-12 h-12 text-sage-green animate-bounce" />
                <p className="mt-4 text-lg text-sage-green font-semibold">Loading RootSage...</p>
                <p className="text-sm text-gray-500 mt-1">Authenticating securely.</p>
            </div>
        );

        const SplashPage = ({ setAccepted, setCurrentPage }) => (
            <div className="flex flex-col items-center justify-end h-screen p-8 bg-sage-green/10">
                <div className="text-center mb-16">
                    <IconLeaf className="w-20 h-20 mx-auto text-sage-green mb-4" />
                    <h2 className="text-4xl font-extrabold text-gray-800">RootSage</h2>
                    <p className="text-lg text-gray-600 mt-2">Identify plants instantly, learn their story.</p>
                </div>
                <div className="w-full">
                    <button 
                        onClick={() => setCurrentPage(PAGES.DISCLAIMER)}
                        className="w-full bg-sage-green text-white py-3 px-4 rounded-xl shadow-lg font-bold text-lg hover:bg-green-700 transition duration-300"
                    >
                        Get Started
                    </button>
                    <p className="text-xs text-gray-500 mt-4 text-center">By continuing, you agree to our terms.</p>
                </div>
            </div>
        );

        const DisclaimerPage = ({ setCurrentPage }) => (
             <div className="p-8 h-screen overflow-y-auto">
                <h2 className="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                    <IconX className="w-5 h-5 mr-2" />Important Disclaimer
                </h2>
                <div className="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                    <h3 className="font-semibold text-lg text-red-600 mb-2">Not for Medical or Toxicity Advice</h3>
                    <p className="text-sm text-gray-600 mb-4">
                        RootSage is designed for plant identification and general knowledge purposes only. 
                        Do **NOT** use this application to determine if a plant is safe for consumption, 
                        or for any medical or health-related advice. Many plants are poisonous or toxic. 
                        **Always** consult a professional expert or emergency services if you suspect poisoning.
                    </p>
                    <h3 className="font-semibold text-lg text-gray-800 mb-2">Accuracy Limitations</h3>
                    <p className="text-sm text-gray-600 mb-6">
                        While we strive for accuracy, identification is based on image recognition technology and may not always be correct. 
                        Do not rely solely on this app for critical decisions.
                    </p>
                </div>
                <div className="mt-8">
                    <button 
                        onClick={() => {
                            localStorage.setItem('disclaimerAccepted', 'true');
                            setCurrentPage(PAGES.HOME);
                        }}
                        className="w-full bg-red-500 text-white py-3 px-4 rounded-xl shadow-lg font-bold text-lg hover:bg-red-600 transition duration-300"
                    >
                        I Understand and Accept
                    </button>
                    <p className="text-xs text-gray-500 mt-4 text-center">Tap to continue to the application.</p>
                </div>
            </div>
        );

        const HomePage = ({ setCurrentPage }) => {
            const { userId, appId } = useFirebase();
            return (
                <div className="p-4 sm:p-6">
                    <div className="bg-white p-6 rounded-2xl shadow-xl">
                        <h2 className="text-2xl font-bold text-green-700 mb-4">Welcome Back!</h2>
                        <p className="text-gray-600 mb-6">Tap the camera to identify your next discovery.</p>
                        
                        <div className="flex justify-center mb-8">
                            <button
                                onClick={() => setCurrentPage(PAGES.CAMERA)}
                                className="flex flex-col items-center justify-center w-36 h-36 bg-sage-green text-white rounded-full shadow-2xl transform transition duration-300 hover:scale-105 active:scale-95"
                            >
                                <IconCamera className="w-10 h-10" />
                                <span className="mt-2 text-lg font-bold">Identify</span>
                            </button>
                        </div>

                        <div className="text-sm text-gray-500 bg-gray-50 p-3 rounded-lg break-words">
                            <p className="font-medium text-gray-700 mb-1">Session Info:</p>
                            <p>App ID: <span className="text-xs font-mono bg-gray-200 px-1 rounded">{appId}</span></p>
                            <p>User ID: <span className="text-xs font-mono bg-gray-200 px-1 rounded">{userId}</span></p>
                        </div>
                    </div>
                </div>
            );
        };

        const HistoryPage = () => {
            const { db, userId } = useFirebase();

            const [history, setHistory] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (!db || !userId) return;

                const historyPath = `artifacts/${db.app.options.appId}/users/${userId}/identification_history`;
                const q = window.firebase.query(window.firebase.collection(db, historyPath));

                // Listen for real-time updates
                const unsubscribe = window.firebase.onSnapshot(q, (snapshot) => {
                    const items = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    })).sort((a, b) => b.timestamp - a.timestamp); // Sort by newest first
                    setHistory(items);
                    setLoading(false);
                }, (error) => {
                    console.error("Error fetching history: ", error);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [db, userId]);


            return (
                <div className="p-4 sm:p-6">
                    <h2 className="text-2xl font-bold text-gray-800 mb-4">Identification History</h2>
                    {loading && <p className="text-center text-gray-500">Loading history...</p>}
                    {!loading && history.length === 0 && (
                        <div className="bg-white p-6 rounded-xl shadow-lg text-center">
                             <IconHistory className="w-8 h-8 text-gray-400 mx-auto mb-2" />
                            <p className="text-gray-500">No identifications found yet. Get started!</p>
                        </div>
                    )}
                    <ul className="space-y-4">
                        {history.map(item => (
                            <li key={item.id} className="bg-white p-4 rounded-xl shadow-md flex items-center">
                                <img 
                                    src={item.imageUrl || `https://placehold.co/60x60/38a169/ffffff?text=Plant`} 
                                    alt={item.plantName || "Identified plant"} 
                                    className="w-16 h-16 object-cover rounded-lg mr-4 border-2 border-green-200"
                                    onError={(e) => { e.target.onerror = null; e.target.src = "https://placehold.co/60x60/38a169/ffffff?text=Error" }}
                                />
                                <div className="flex-grow">
                                    <h3 className="font-bold text-lg text-green-800">{item.plantName || "Unknown Plant"}</h3>
                                    <p className="text-sm text-gray-500">
                                        Identified on: {new Date(item.timestamp).toLocaleDateString()}
                                    </p>
                                </div>
                            </li>
                        ))}
                    </ul>
                </div>
            );
        };

        const ProfilePage = ({ setCurrentPage }) => {
             const { auth, userId } = useFirebase();

             const handleSignOut = async () => {
                try {
                    // Sign out of the current Firebase session
                    await window.firebase.signOut(auth);
                    // Force anonymous sign-in immediately after signing out for continuity
                    await window.firebase.signInAnonymously(auth);
                    setCurrentPage(PAGES.HOME);
                } catch (error) {
                    console.error("Sign out failed:", error);
                    // Display error message to user (using a custom modal/message box, not alert)
                }
            };
            
            return (
                <div className="p-4 sm:p-6">
                    <div className="bg-white p-6 rounded-2xl shadow-xl">
                        <h2 className="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                            <IconUser className="w-6 h-6 mr-2 text-sage-green" /> User Profile
                        </h2>
                        <div className="space-y-3 mb-6 border-b pb-4">
                            <p className="text-sm text-gray-600">
                                This app is running securely in a collaborative environment.
                            </p>
                            <p className="text-sm font-semibold text-gray-700 bg-gray-100 p-2 rounded-lg break-words">
                                Your current User ID: <span className="font-mono text-xs">{userId}</span>
                            </p>
                            
                        </div>

                        <h3 className="font-semibold text-lg text-gray-800 mb-2">Settings</h3>
                        <button
                            onClick={handleSignOut}
                            className="w-full bg-red-500 text-white py-2 px-4 rounded-xl font-medium text-sm hover:bg-red-600 transition duration-300 shadow-md"
                        >
                            Sign Out (Start New Anonymous Session)
                        </button>
                    </div>
                </div>
            );
        };

        const CameraPage = ({ setCurrentPage, setLastResult }) => {
            const { db, auth, userId, appId } = useFirebase();
            const [imageFile, setImageFile] = useState(null);
            const [previewUrl, setPreviewUrl] = useState(null);
            const [isIdentifying, setIsIdentifying] = useState(false);
            const [message, setMessage] = useState('');
            const fileInputRef = React.useRef(null);

            const handleFileChange = (event) => {
                const file = event.target.files[0];
                if (file) {
                    setImageFile(file);
                    setPreviewUrl(URL.createObjectURL(file));
                    setMessage('');
                }
            };

            const resetCamera = () => {
                setImageFile(null);
                setPreviewUrl(null);
                setIsIdentifying(false);
                setMessage('');
                if(fileInputRef.current) fileInputRef.current.value = null;
            }

            const simulateIdentification = async (file) => {
                if (!file) return;

                setIsIdentifying(true);
                setMessage('Uploading image...');

                try {
                    // 1. Upload Image to Storage
                    const storage = window.firebase.getStorage(db.app);
                    const storagePath = `artifacts/${appId}/images/${userId}/${Date.now()}-${file.name}`;
                    const imageRef = window.firebase.ref(storage, storagePath);
                    const uploadResult = await window.firebase.uploadBytes(imageRef, file);
                    const imageUrl = await window.firebase.getDownloadURL(uploadResult.ref);

                    setMessage('Identifying plant using LLM...');
                    
                    // 2. Mock LLM Identification based on image mime type for demo
                    // In a real app, you would pass 'imageUrl' or 'file' (after conversion) to a vision model API.
                    await new Promise(resolve => setTimeout(resolve, 3000)); // Simulate API call delay
                    
                    const mockResults = [
                        { name: "Common Sunflower", confidence: 0.95, description: "Known for its large flower heads and tall stature, often used for seeds and oil. Native to North America." },
                        { name: "Dandelion (Taraxacum)", confidence: 0.88, description: "A common, recognizable flowering plant. All parts are edible, but it's often considered a weed." },
                        { name: "Poison Ivy (Toxicodendron radicans)", confidence: 0.05, description: "Warning: Extremely low confidence. Known for causing an itchy allergic rash upon contact. 'Leaves of three, let it be!'" }
                    ];

                    // 3. Save History to Firestore
                    const resultData = {
                        plantName: mockResults[0].name,
                        confidence: mockResults[0].confidence,
                        description: mockResults[0].description,
                        imageUrl: imageUrl,
                        timestamp: Date.now(),
                    };
                    
                    const historyCollectionPath = `artifacts/${appId}/users/${userId}/identification_history`;
                    await window.firebase.addDoc(window.firebase.collection(db, historyCollectionPath), resultData);

                    setMessage('Identification complete!');
                    
                    // 4. Navigate to result page
                    setLastResult(resultData);
                    setCurrentPage(PAGES.RESULT);

                } catch (e) {
                    console.error("Identification process error:", e);
                    setMessage('An error occurred during identification. Check console.');
                } finally {
                    setIsIdentifying(false);
                }
            };

            return (
                <div className="p-4 sm:p-6">
                    <h2 className="text-2xl font-bold text-gray-800 mb-4">Capture Plant Image</h2>
                    <div className="bg-white p-6 rounded-2xl shadow-xl">
                        <input
                            type="file"
                            accept="image/*"
                            onChange={handleFileChange}
                            ref={fileInputRef}
                            className="hidden"
                            disabled={isIdentifying}
                        />

                        {previewUrl ? (
                            <div className="mb-4 relative">
                                <img src={previewUrl} alt="Preview" className="w-full h-auto max-h-80 object-cover rounded-xl border-4 border-sage-green" />
                                <button 
                                    onClick={resetCamera} 
                                    className="absolute top-2 right-2 bg-black/50 text-white p-1 rounded-full hover:bg-black/70 transition duration-200"
                                >
                                    <IconX className="w-5 h-5" />
                                </button>
                            </div>
                        ) : (
                            <button
                                onClick={() => fileInputRef.current.click()}
                                className="w-full h-64 border-4 border-dashed border-gray-300 rounded-xl flex flex-col items-center justify-center text-gray-500 hover:border-sage-green hover:text-sage-green transition duration-300"
                                disabled={isIdentifying}
                            >
                                <IconCamera className="w-10 h-10 mb-2" />
                                <span className="font-semibold">Tap to select or take photo</span>
                            </button>
                        )}

                        <button
                            onClick={() => simulateIdentification(imageFile)}
                            className={`w-full py-3 px-4 rounded-xl font-bold text-lg transition duration-300 mt-4 ${
                                imageFile && !isIdentifying
                                    ? 'bg-sage-green text-white hover:bg-green-700 shadow-lg'
                                    : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                            }`}
                            disabled={!imageFile || isIdentifying}
                        >
                            {isIdentifying ? (
                                <div className="flex items-center justify-center">
                                    <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                    {message}
                                </div>
                            ) : 'Identify Plant'}
                        </button>
                        {message && !isIdentifying && <p className="text-sm text-center text-green-600 mt-2">{message}</p>}
                    </div>
                </div>
            );
        };
        
        const ResultPage = ({ setCurrentPage, result }) => {
            if (!result) {
                return (
                    <div className="p-4 text-center">
                        <p className="text-red-500">No result data found.</p>
                        <button onClick={() => setCurrentPage(PAGES.HOME)} className="text-sage-green mt-4">Go Home</button>
                    </div>
                );
            }

            const confidencePercentage = Math.round(result.confidence * 100);

            return (
                <div className="p-4 sm:p-6">
                    <h2 className="text-2xl font-bold text-gray-800 mb-4">Identification Result</h2>
                    <div className="bg-white rounded-2xl shadow-xl overflow-hidden">
                        <img 
                            src={result.imageUrl || `https://placehold.co/600x400/38a169/ffffff?text=Plant`} 
                            alt={result.plantName} 
                            className="w-full h-64 object-cover"
                            onError={(e) => { e.target.onerror = null; e.target.src = "https://placehold.co/600x400/38a169/ffffff?text=Error" }}
                        />
                        <div className="p-6">
                            <h3 className="text-3xl font-extrabold text-sage-green mb-2">{result.plantName}</h3>
                            <div className="flex items-center space-x-2 mb-4">
                                <span className="text-sm font-semibold">Confidence:</span>
                                <span className={`px-3 py-1 text-sm font-bold rounded-full ${confidencePercentage >= 90 ? 'bg-green-100 text-green-700' : confidencePercentage >= 70 ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'}`}>
                                    {confidencePercentage}%
                                </span>
                            </div>
                            
                            <p className="text-gray-700 mb-6 leading-relaxed">{result.description}</p>
                            
                            <button 
                                onClick={() => setCurrentPage(PAGES.HOME)}
                                className="w-full bg-sage-green text-white py-3 px-4 rounded-xl font-bold text-lg hover:bg-green-700 transition duration-300 shadow-md"
                            >
                                Done / New Identification
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const NavBar = ({ currentPage, setCurrentPage }) => {
            const navItems = [
                { page: PAGES.HOME, icon: IconHome, label: 'Home' },
                { page: PAGES.CAMERA, icon: IconCamera, label: 'Camera' },
                { page: PAGES.HISTORY, icon: IconHistory, label: 'History' },
                { page: PAGES.PROFILE, icon: IconUser, label: 'Profile' },
            ];

            return (
                <footer className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg z-10">
                    <div className="flex justify-around items-center h-16 max-w-xl mx-auto">
                        {navItems.map(({ page, icon: Icon, label }) => (
                            <button
                                key={page}
                                onClick={() => setCurrentPage(page)}
                                className={`flex flex-col items-center p-2 text-xs font-medium transition duration-200 ${
                                    page === currentPage ? 'text-sage-green' : 'text-gray-500 hover:text-green-600'
                                }`}
                            >
                                <Icon className="w-6 h-6 mb-0.5" />
                                {label}
                            </button>
                        ))}
                    </div>
                </footer>
            );
        };


        // --- Main Application Component (Fixed and Refactored) ---
        const App = () => {
            const [currentPage, setCurrentPage] = useState(
                localStorage.getItem('disclaimerAccepted') === 'true' ? PAGES.HOME : PAGES.SPLASH
            );
            const [lastResult, setLastResult] = useState(null);

            // Firebase State Management
            const [firebaseState, setFirebaseState] = useState({
                db: null,
                auth: null,
                userId: null,
                appId: null,
                isLoading: true,
            });

            // 1. Firebase Initialization and Authentication Effect (THE FIX)
            useEffect(() => {
                const setupFirebase = async () => {
                    try {
                        // Safely retrieve required global variables
                        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                        
                        // 2. Initialize App
                        const app = window.firebase.initializeApp(firebaseConfig);
                        const db = window.firebase.getFirestore(app);
                        const auth = window.firebase.getAuth(app);
                        
                        // 3. Sign In (Custom Token if available, otherwise Anonymous)
                        let userCredential;
                        if (initialAuthToken) {
                            userCredential = await window.firebase.signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            userCredential = await window.firebase.signInAnonymously(auth);
                        }
                        
                        const userId = userCredential.user.uid;

                        // 4. Update state with initialized Firebase instances
                        setFirebaseState({
                            db,
                            auth,
                            userId,
                            appId,
                            isLoading: false,
                        });
                        console.log("Firebase and Authentication Setup Complete. User ID:", userId);

                    } catch (error) {
                        console.error("Firebase initialization failed:", error);
                        // Still set loading to false to unblock the UI, potentially showing an error state later
                        setFirebaseState(s => ({ ...s, isLoading: false })); 
                    }
                };
                setupFirebase();
            }, []); // Run only once on mount

            // Component to render based on the current page
            const renderPage = () => {
                if (firebaseState.isLoading) {
                    return <LoadingScreen />;
                }

                switch (currentPage) {
                    case PAGES.SPLASH:
                        return <SplashPage setCurrentPage={setCurrentPage} />;
                    case PAGES.DISCLAIMER:
                        return <DisclaimerPage setCurrentPage={setCurrentPage} />;
                    case PAGES.HOME:
                        return <HomePage setCurrentPage={setCurrentPage} />;
                    case PAGES.CAMERA:
                        return <CameraPage setCurrentPage={setCurrentPage} setLastResult={setLastResult} />;
                    case PAGES.HISTORY:
                        return <HistoryPage />;
                    case PAGES.PROFILE:
                        return <ProfilePage setCurrentPage={setCurrentPage} />;
                    case PAGES.RESULT:
                        return <ResultPage setCurrentPage={setCurrentPage} result={lastResult} />;
                    default:
                        return <HomePage setCurrentPage={setCurrentPage} />;
                }
            };

            // Provider for Firebase Context
            return (
                <FirebaseContext.Provider value={firebaseState}>
                    <div className="flex flex-col min-h-screen max-w-xl mx-auto bg-white shadow-xl rounded-xl sm:my-8 sm:overflow-hidden">
                        
                        {/* Header (Hidden on splash/disclaimer/camera for full screen) */}
                        {currentPage !== PAGES.SPLASH && currentPage !== PAGES.CAMERA && currentPage !== PAGES.DISCLAIMER && (
                            <header className="sticky top-0 bg-white p-4 border-b border-gray-200 flex items-center justify-between z-10">
                                <h1 className="text-xl font-bold text-green-700 flex items-center">
                                    <IconLeaf className="w-6 h-6 mr-1" /> RootSage
                                </h1>
                                <button 
                                    onClick={() => setCurrentPage(PAGES.PROFILE)}
                                    className="text-sm text-gray-500 hover:text-green-600 flex items-center"
                                >
                                    <IconUser className="w-4 h-4 mr-1"/> Profile
                                </button>
                            </header>
                        )}

                        {/* Main Content Area */}
                        <main className={`flex-grow overflow-y-auto ${currentPage !== PAGES.SPLASH && currentPage !== PAGES.DISCLAIMER && 'mb-16'} ${currentPage === PAGES.SPLASH || currentPage === PAGES.DISCLAIMER ? 'h-screen' : 'pb-4'}`}>
                            {renderPage()}
                        </main>

                        {/* Navigation Bar (Hidden on splash/disclaimer/camera) */}
                        {currentPage !== PAGES.SPLASH && currentPage !== PAGES.DISCLAIMER && currentPage !== PAGES.CAMERA && (
                            <NavBar currentPage={currentPage} setCurrentPage={setCurrentPage} />
                        )}
                    </div>
                </FirebaseContext.Provider>
            );
        };

        // Render the main App component
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);

    </script>
</body>
</html>
