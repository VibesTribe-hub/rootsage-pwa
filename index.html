<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rootsage: Ethical Foraging</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged, 
            GoogleAuthProvider, 
            signInWithPopup,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            collection, 
            setDoc, 
            getDoc, 
            onSnapshot,
            serverTimestamp,
            getDocs,
            query,
            where
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";


        // --- SECURITY FIX: Use Placeholder for GitHub Actions Injection ---
        // The GitHub Action (deploy.yml) will replace $$FIREBASE_API_KEY$$ with the secret value during build.
        const SECURE_FIREBASE_CONFIG = {
            apiKey: "$$FIREBASE_API_KEY$$",
            authDomain: "rootsagev2.firebaseapp.com",
            projectId: "rootsagev2",
            storageBucket: "rootsagev2.firebasestorage.app",
            messagingSenderId: "355755573557",
            appId: "1:355755573557:web:5e23d0587264097934cc7c"
        };
        // ------------------------------------------------------------------

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Initialize Firebase
        const firebaseApp = initializeApp(SECURE_FIREBASE_CONFIG);
        const db = getFirestore(firebaseApp);
        const auth = getAuth(firebaseApp);
        
        // Expose Firebase functions to the global window object for use in the Babel script
        window.firebaseApp = firebaseApp;
        window.db = db;
        window.auth = auth;
        window.onAuthStateChanged = onAuthStateChanged;
        window.signInWithPopup = signInWithPopup;
        window.GoogleAuthProvider = GoogleAuthProvider;
        window.signOut = signOut;
        window.collection = collection;
        window.doc = doc;
        window.setDoc = setDoc;
        window.getDoc = getDoc;
        window.onSnapshot = onSnapshot;
        window.serverTimestamp = serverTimestamp;
        window.getDocs = getDocs;
        window.query = query;
        window.where = where;

        // Ensure logging is set for better debugging visibility
        setLogLevel('Debug');
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        /* Custom earthy scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 8px; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #457849; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background-color: #e5e7eb; }
        .font-inter { font-family: 'Inter', sans-serif; }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>
</head>
<body class="bg-gray-100 font-inter custom-scroll">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;
        const ReactDOM = window.ReactDOM;

        // --- FIREBASE PATHS & CONSTANTS (From index (3).html) ---
        const appId = 'default-app-id'; // Use a placeholder if not defined globally
        const USER_DATA_PATH = `/artifacts/${appId}/users`;
        
        const INITIAL_USER_DATA = {
            displayName: "Anonymous User",
            score: 0,
            collections: 0,
            lastActivity: null,
        };

        // --- FIREBASE HOOKS (From index (3).html) ---

        const useAuth = () => {
            const [user, setUser] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [dbInstance, setDbInstance] = useState(null);
            const [authInstance, setAuthInstance] = useState(null);
            const [authProvider, setAuthProvider] = useState(null);

            useEffect(() => {
                // Check if the required Firebase variables are exposed by the module script
                if (window.auth && window.db && window.GoogleAuthProvider) {
                    setAuthInstance(window.auth);
                    setDbInstance(window.db);
                    setAuthProvider(new window.GoogleAuthProvider());
                    
                    const unsubscribe = window.onAuthStateChanged(window.auth, (currentUser) => {
                        if (currentUser) {
                            setUser(currentUser);
                        } else {
                            setUser(null);
                        }
                        setIsAuthReady(true);
                    });

                    return () => unsubscribe();
                } else {
                    // This path is hit if the module script failed to run, setting the app to local-only mode
                    console.error("Firebase instances not globally available. Running in local mode.");
                    setIsAuthReady(true); 
                }
            }, []);

            const signInWithGoogle = useCallback(async () => {
                if (!authInstance || !authProvider) return;
                try {
                    await window.signInWithPopup(authInstance, authProvider);
                } catch (error) {
                    console.error("Google Sign-In failed:", error);
                }
            }, [authInstance, authProvider]);

            const signOutUser = useCallback(async () => {
                if (!authInstance) return;
                try {
                    await window.signOut(authInstance);
                    setUser(null);
                } catch (error) {
                    console.error("Sign-out failed:", error);
                }
            }, [authInstance]);

            return { user, isAuthReady, dbInstance, signInWithGoogle, signOutUser, userId: user?.uid };
        };

        const useUserData = (userId, dbInstance, isAuthReady) => {
            const [data, setData] = useState(null);
            
            useEffect(() => {
                if (!isAuthReady || !dbInstance || !userId) {
                    setData(INITIAL_USER_DATA);
                    return;
                }

                const userDocRef = window.doc(dbInstance, USER_DATA_PATH, userId);
                
                const unsubscribe = window.onSnapshot(userDocRef, async (docSnapshot) => {
                    if (docSnapshot.exists()) {
                        setData(docSnapshot.data());
                    } else {
                        const newUserData = {
                            ...INITIAL_USER_DATA,
                            displayName: window.auth.currentUser?.displayName || "Anonymous User",
                            createdAt: window.serverTimestamp(),
                            userId: userId,
                        };
                        try {
                            await window.setDoc(userDocRef, newUserData);
                            setData(newUserData);
                        } catch (e) {
                            console.error("Error creating user document:", e);
                            setData(INITIAL_USER_DATA);
                        }
                    }
                }, (error) => {
                    console.error("Error listening to user data:", error);
                    setData(INITIAL_USER_DATA);
                });

                return () => unsubscribe();
            }, [userId, dbInstance, isAuthReady]);

            const updateScore = useCallback(async (points) => {
                if (!dbInstance || !userId) return;
                const userDocRef = window.doc(dbInstance, USER_DATA_PATH, userId);
                try {
                    await window.setDoc(userDocRef, { 
                        score: (data?.score || 0) + points,
                        lastActivity: window.serverTimestamp()
                    }, { merge: true });
                } catch (e) {
                    console.error("Error updating score:", e);
                }
            }, [dbInstance, userId, data]);

            return { userData: data, updateScore };
        };

        const useCollections = (dbInstance, isAuthReady, userId) => {
            const [collections, setCollections] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (!isAuthReady || !dbInstance || !userId) {
                    setCollections([]);
                    setLoading(false);
                    return;
                }
                
                const userCollectionsRef = window.collection(dbInstance, USER_DATA_PATH, userId, 'my_plants');

                const unsubscribe = window.onSnapshot(userCollectionsRef, (snapshot) => {
                    const list = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setCollections(list);
                    setLoading(false);
                }, (error) => {
                    console.error("Error fetching collections:", error);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [dbInstance, isAuthReady, userId]);

            const addPlantToCollection = useCallback(async (plantData) => {
                if (!dbInstance || !userId) {
                    return { success: false, message: "Authentication required to save." };
                }

                const userCollectionsRef = window.collection(dbInstance, USER_DATA_PATH, userId, 'my_plants');
                
                try {
                    const newDocRef = window.doc(userCollectionsRef);
                    await window.setDoc(newDocRef, {
                        ...plantData,
                        collectedAt: window.serverTimestamp(),
                        userId: userId,
                    });
                    
                    return { success: true, message: "Plant added to collection!" };
                } catch (e) {
                    console.error("Error adding plant to collection:", e);
                    return { success: false, message: "Failed to add plant to collection." };
                }
            }, [dbInstance, userId]);

            return { collections, loading, addPlantToCollection };
        };
       
        // --- Custom Theme/Styles (Using Hex for consistency with user request) ---
        const COLORS = {
            SAND: '#FBF3D4',
            DARK_GREEN: '#1D4520',
            FOREST_GREEN: '#346A3A',
            BROWN: '#7F5539',
        };

        // Utility function to convert File to Base64 for the Gemini API
        const fileToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        };

        // --- API Calls (Contained within this file) ---

        const generateRecipes = async (plantName) => {
            const systemPrompt = `Act as a culinary expert. Generate 3 creative and simple recipes suitable for a home cook using the ingredient: ${plantName}. The response must be a valid JSON array matching the provided schema.`;
            const userQuery = `Generate 3 recipes using ${plantName}.`;
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                recipeName: { type: "STRING" },
                                description: { type: "STRING" },
                                ingredients: { type: "ARRAY", items: { type: "STRING" } }
                            },
                            propertyOrdering: ["recipeName", "description", "ingredients"]
                        }
                    }
                }
            };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
            
            try {
                for (let i = 0; i < 3; i++) {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.ok) {
                        const result = await response.json();
                        const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (jsonText) return JSON.parse(jsonText);
                    }
                    if (i < 2) await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, i)));
                }
                throw new Error('Failed to fetch recipes after multiple retries.');
            } catch (error) {
                console.error("Gemini Recipe API Error:", error);
                return [];
            }
        };

        const identifyPlant = async (base64Image) => {
            const systemPrompt = `You are the Rootsage Identification Bot. Your task is to analyze the provided image of a plant and return the single most likely identification in a specific JSON format. Do not include any other text or explanation.

            JSON Schema required:
            {
                "name": "Most likely common and scientific name (e.g., Common Dandelion (Taraxacum officinale))",
                "confidence": "Confidence percentage as a string (e.g., '95%')",
                "analysis": "A concise analysis of the plant, including edibility status (Edible, Non-edible, or Caution required) and key identification markers.",
                "funFact": "One short, interesting fact about the identified plant."
            }
            
            Return ONLY the JSON object.`;
            
            const userQuery = "Identify this plant, its edibility, caution level, and provide a fun fact.";
            
            const payload = {
                contents: [{
                    role: "user",
                    parts: [
                        { text: userQuery },
                        { inlineData: { mimeType: "image/png", data: base64Image } }
                    ]
                }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            name: { type: "STRING" },
                            confidence: { type: "STRING" },
                            analysis: { type: "STRING" },
                            funFact: { type: "STRING" }
                        },
                        propertyOrdering: ["name", "confidence", "analysis", "funFact"]
                    }
                }
            };

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;

            try {
                for (let i = 0; i < 3; i++) {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (jsonText) return JSON.parse(jsonText);
                    }
                    if (i < 2) await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, i)));
                }
                throw new Error('Identification failed after multiple retries.');
            } catch (error) {
                console.error("Gemini Identification API Error:", error);
                // Return a failure structure consistent with the schema
                return {
                    name: "Identification Failed",
                    confidence: "0%",
                    analysis: "Could not identify the plant. Please ensure the image is clear and well-lit.",
                    funFact: "Try taking the picture from a different angle!"
                };
            }
        };

        const diagnosePlant = async (base64Image, prompt) => {
            const systemPrompt = "You are the Rootsage Plant Doctor. Analyze the provided image of a plant. If a disease is detected, identify it and provide clear, actionable care instructions (how to treat it and prevent recurrence). If no disease is detected, confirm the plant is healthy and provide general care tips.";
            const userQuery = `Diagnose the health of this plant based on the image: ${prompt}`;
            const payload = {
                contents: [{
                    role: "user",
                    parts: [
                        { text: userQuery },
                        { inlineData: { mimeType: "image/png", data: base64Image } }
                    ]
                }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;

            try {
                for (let i = 0; i < 3; i++) {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.ok) {
                        const result = await response.json();
                        return result.candidates?.[0]?.content?.parts?.[0]?.text || "Diagnosis failed. Please try a clearer image.";
                    }
                    if (i < 2) await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, i)));
                }
                throw new Error('Diagnosis failed after multiple retries.');
            } catch (error) {
                console.error("Gemini Doctor API Error:", error);
                return "An error occurred while connecting to the Plant Doctor service. Check your network or API key.";
            }
        };


        // --- Data Models and Logic (From index (2).html) ---

        const defaultProfile = {
            bio: "Aspiring botanist and green thumb!",
            profilePicUrl: "https://placehold.co/100x100/34D399/ffffff?text=U",
            lastUpdated: new Date().toISOString()
        };

        const getBadgeTier = (count) => {
            if (count >= 15) return { name: "Master Botanist", color: "bg-amber-500", icon: "🌱", nextTier: 15 };
            if (count >= 5) return { name: "Green Thumb Apprentice", color: "bg-green-600", icon: "🌿", nextTier: 15 };
            return { name: "Novice Gardener", color: "bg-gray-500", icon: "✨", nextTier: 5 };
        };

        const MOCK_SEASONAL_QUESTS = [
            // Updated to use consistent 'requiredCollectible' for accurate completion check
            { id: 'q1', name: 'Spring Quest: Harvest Ramps (Wild Leeks)', isSeasonal: true, requiredCollectible: 'Wild Leek', status: 'In Progress', caution: true, badge: '🧄' },
            { id: 'q2', name: 'Summer Quest: Spruce Tip Sugar', isSeasonal: true, requiredCollectible: 'Spruce Tip', status: 'In Progress', caution: false, badge: '🌲🍯' },
            { id: 'q3', name: 'Autumn Quest: Identify Edible Mushrooms', isSeasonal: true, requiredCollectible: 'Mushroom', status: 'Locked', caution: true, badge: '🍄' },
            { id: 'q4', name: 'Year-Round: Identify 10 Different Fungi', isSeasonal: false, requiredCollectible: 'Fungi', status: 'In Progress', caution: false, badge: '🦠' },
        ];

        // --- Icons (Inline SVG) ---

        const Icon = ({ d, className = "w-6 h-6" }) => (
            <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" xmlns="http://www.w3.org/2000/svg">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d={d} />
            </svg>
        );

        const CameraIcon = (props) => <Icon {...props} d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.86-1.503A2 2 0 0111.07 4h1.86a2 2 0 011.664.89l.86 1.503a2 2 0 001.664.89H21a2 2 0 012 2v9a2 2 0 01-2 2H3a2 2 0 01-2-2V9zM12 17a4 4 0 100-8 4 4 0 000 8z" />;
        const LeafIcon = (props) => <Icon {...props} d="M16.5 6v.75m0 3v.75m0 3v.75m0 3v.75M9 10.5l.343-3.084a2.25 2.25 0 014.47-1.077l.51-1.011c.451-.898.156-1.93-.728-2.381A1.65 1.65 0 0012 2.25v2.25M9 10.5h.75m3-.75h.75m-3 .75h.75M16.5 6.75H20.25a.75.75 0 01.75.75V18c0 .414-.336.75-.75.75H3.75a.75.75 0 01-.75-.75V7.5c0-.414.336-.75.75-.75h3.75m9 0h3.75" />;
        const UserIcon = (props) => <Icon {...props} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />;
        const BookIcon = (props) => <Icon {...props} d="M12 6.75h.008v.008H12V6.75zm1.5 6h.008v.008H13.5V12.75zm-3 0h.008v.008H10.5V12.75zm-3 3h.008v.008H7.5V15.75zm3 0h.008v.008H10.5V15.75zm3 0h.008v.008H13.5V15.75zM12 2.25h-5.25A2.25 2.25 0 004.5 4.5v15c0 1.242.755 2.348 1.884 2.76A2.25 2.25 0 008.25 22.5h7.5A2.25 2.25 0 0017.5 20.25v-15A2.25 2.25 0 0015.75 2.25H12zM7 4.5h5" />;
        const HeartIcon = (props) => <Icon {...props} d="M21 8.25c0-2.485-2.015-4.5-4.5-4.5S12 5.765 12 8.25s2.015 4.5 4.5 4.5S21 10.735 21 8.25zM12 18.25c0 2.485-2.015 4.5-4.5 4.5S3 20.735 3 18.25s2.015-4.5 4.5-4.5S12 15.765 12 18.25z" />;
        const CrossIcon = (props) => <Icon {...props} d="M6 18L18 6M6 6l12 12" />;
        const PlusIcon = (props) => <Icon {...props} d="M12 4v16m8-8H4" />;
        const TrophyIcon = (props) => <Icon {...props} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />;
        const LoginIcon = (props) => <Icon {...props} d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />;


        // --- Preloader Component ---
        const BouncingLogoPreloader = ({ onAnimationEnd }) => {
            React.useEffect(() => {
                const timer = setTimeout(() => {
                    onAnimationEnd(false); // Set preloader off after 3s
                }, 3000); // 3 seconds for the bouncing animation
                return () => clearTimeout(timer);
            }, [onAnimationEnd]);

            return (
                <div style={{ backgroundColor: COLORS.DARK_GREEN }} className="fixed inset-0 flex flex-col items-center justify-center z-50 transition-opacity duration-500">
                    <style>
                        {`
                        @keyframes bounce {
                            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
                            40% { transform: translateY(-30px); }
                            60% { transform: translateY(-15px); }
                        }
                        .bouncing-logo { animation: bounce 2s infinite; }
                        `}
                    </style>
                    <div className="bouncing-logo p-4 text-6xl md:text-8xl rounded-full shadow-2xl shadow-green-900/50" style={{ backgroundColor: COLORS.FOREST_GREEN, color: COLORS.SAND }}>
                        🌿
                    </div>
                    <p className="mt-8 text-xl font-bold tracking-wider" style={{ color: COLORS.SAND }}>Rootsage</p>
                    <p className="mt-2 text-sm opacity-70" style={{ color: COLORS.SAND }}>Identifying nature's secrets...</p>
                </div>
            );
        };

        // --- Agreement Gate Component (ToA & Stewardship) ---
        const AgreementGate = ({ onAgree }) => {
            const [isAccepted, setIsAccepted] = useState(false);

            const StewardshipCode = () => (
                <section className="p-6 rounded-xl shadow-lg mb-10 border-t-4 border-red-700 bg-red-50/70">
                    <h2 className="text-xl font-bold mb-4 text-red-700 flex items-center">
                        ⚠️ Edibility & Consumption Agreement
                    </h2>
                    <p className="text-sm leading-relaxed mb-4 text-gray-700">
                        <span className="font-extrabold text-red-800">THIS IS A WARNING:</span> By using the edibility analysis features, you assume all risk. The analysis is for informational purposes only.
                    </p>
                    <ul className="list-disc pl-5 space-y-3 text-sm text-gray-700">
                        <li className="bg-red-100 p-2 rounded-lg border border-red-300">
                            <span className="font-extrabold text-red-800 text-base">100% Certainty is Required:</span> **NEVER** consume a plant unless you are absolutely certain of its identity and edibility. Misidentification can be **FATAL**.
                        </li>
                        <li>
                            <span className="font-semibold text-gray-800">Personal Responsibility:</span> You are responsible for any consumption, preparation, or allergic reactions.
                        </li>
                    </ul>

                    <h2 className="text-xl font-bold mt-8 mb-4 text-green-700 flex items-center">
                        💚 Stewardship Code of Conduct
                    </h2>
                    <p className="text-sm leading-relaxed mb-4 text-gray-700">
                        We advocate for ethical foraging. Please uphold these practices to ensure sustainability:
                    </p>
                    <ol className="list-decimal pl-5 space-y-4 text-sm text-gray-700">
                        <li>
                            <span className="font-extrabold text-green-800 text-base">Take Only What You Need:</span> Never harvest more than 10-15% of a patch.
                        </li>
                        <li>
                            <span className="font-extrabold text-green-800 text-base">Harvest Sustainably:</span> Avoid disturbing roots, bulbs, or the surrounding environment.
                        </li>
                        <li>
                            <span className="font-extrabold text-green-800 text-base">Respect Wildlife:</span> Leave enough for animals that depend on the plant for survival.
                        </li>
                    </ol>
                </section>
            );

            return (
                <div style={{ backgroundColor: COLORS.SAND }} className="min-h-screen p-5 flex flex-col items-center justify-center">
                    <div className="max-w-md w-full">
                        <header className="text-center mb-6">
                            <h1 className="text-4xl font-extrabold" style={{ color: COLORS.FOREST_GREEN }}>Rootsage</h1>
                            <p className="text-base" style={{ color: COLORS.BROWN }}>Ethical Foraging Starts Here</p>
                        </header>

                        <StewardshipCode />

                        <div className="mt-6 p-4 bg-white rounded-xl shadow-lg border border-gray-200">
                            <input type="checkbox" id="agree-check" checked={isAccepted} onChange={(e) => setIsAccepted(e.target.checked)} className="form-checkbox h-5 w-5 text-green-600 rounded focus:ring-green-500" />
                            <label htmlFor="agree-check" className="ml-3 text-sm font-medium text-gray-800">
                                I have read, understand, and agree to the Consumption and Stewardship terms.
                            </label>
                            <button
                                onClick={onAgree}
                                disabled={!isAccepted}
                                className={`mt-4 w-full py-3 rounded-xl text-white font-bold transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed shadow-md ${
                                    isAccepted ? 'bg-green-600 hover:bg-green-700' : 'bg-gray-400'
                                }`}
                            >
                                Enter Rootsage
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Nav Bar Component ---
        const NavBar = ({ currentPage, setCurrentPage, badgeCount }) => {
            const badge = getBadgeTier(badgeCount);
            const NavItem = ({ page, icon, label }) => (
                <button
                    onClick={() => setCurrentPage(page)}
                    className={`p-3 flex flex-col items-center justify-center text-xs transition-colors rounded-xl ${
                        currentPage === page ? 'text-white shadow-lg shadow-green-500/50' : 'text-gray-600 hover:text-green-600'
                    }`}
                    style={{ backgroundColor: currentPage === page ? COLORS.FOREST_GREEN : 'transparent', color: currentPage === page ? COLORS.SAND : COLORS.DARK_GREEN }}
                >
                    {icon}
                    <span className="mt-1 text-[10px] font-medium">{label}</span>
                </button>
            );

            return (
                <div className="fixed bottom-0 left-0 right-0 bg-white shadow-2xl p-2 z-10 border-t border-gray-200">
                    <div className="flex justify-around max-w-lg mx-auto">
                        <NavItem page="identify" label="Identify" icon={<CameraIcon className="w-5 h-5" />} />
                        <NavItem page="doctor" label="Doctor" icon={<HeartIcon className="w-5 h-5" />} />
                        <NavItem page="collectibles" label="Collectibles" icon={<LeafIcon className="w-5 h-5" />} />
                        <NavItem page="journal" label="Journal" icon={<BookIcon className="w-5 h-5" />} />
                        <NavItem page="quests" label="Quests" icon={<TrophyIcon className="w-5 h-5" />} />
                        <NavItem page="profile" label="Profile" icon={<UserIcon className="w-5 h-5" />} />
                    </div>
                    <div className={`absolute top-0 right-2 -translate-y-full px-3 py-1 text-xs font-bold rounded-full shadow-lg ${badge.color} text-white transition-all duration-300 transform ${badgeCount > 0 ? 'scale-100' : 'scale-0'}`}>
                        {badgeCount} {badge.icon}
                    </div>
                </div>
            );
        };

        // --- Placeholder Components for Structure (Must be in index (2).html) ---

        const IdentifyPlant = ({ identifyPlant, fileToBase64, addPlantToCollection, updateScore }) => {
            const [file, setFile] = useState(null);
            const [imagePreview, setImagePreview] = useState(null);
            const [isIdentifying, setIsIdentifying] = useState(false);
            const [result, setResult] = useState(null);
            const [message, setMessage] = useState('');

            const handleFileChange = (e) => {
                const selectedFile = e.target.files[0];
                if (selectedFile) {
                    setFile(selectedFile);
                    setImagePreview(URL.createObjectURL(selectedFile));
                    setResult(null);
                }
            };

            const handleIdentify = async () => {
                if (!file) return;

                setIsIdentifying(true);
                setMessage('Uploading and identifying plant...');
                try {
                    const base64Image = await fileToBase64(file);
                    const identificationResult = await identifyPlant(base64Image);
                    setResult(identificationResult);

                    // Add to collection upon successful identification
                    if (identificationResult.name !== "Identification Failed") {
                        const saveResponse = await addPlantToCollection({ 
                            name: identificationResult.name, 
                            commonName: identificationResult.name.split('(')[0].trim(),
                            analysis: identificationResult.analysis,
                            imageUrl: imagePreview, // Use local URL for display, or a cloud upload URL in a real app
                            confidence: identificationResult.confidence 
                        });
                        
                        // Update score for a successful collection (e.g., 10 points)
                        if (saveResponse.success) {
                             await updateScore(10);
                             setMessage(`Identified! ${saveResponse.message}`);
                        } else {
                            setMessage(`Identified! (Local save only. ${saveResponse.message})`);
                        }
                    } else {
                        setMessage("Identification failed. Please try again.");
                    }

                } catch (error) {
                    console.error("Identification process error:", error);
                    setMessage("An error occurred during identification.");
                } finally {
                    setIsIdentifying(false);
                    setFile(null);
                    setImagePreview(null);
                }
            };

            const StatusBlock = ({ name, value, colorClass }) => (
                <div className={`p-3 rounded-lg flex items-center justify-between ${colorClass} shadow-md`}>
                    <span className="text-sm font-medium text-white">{name}</span>
                    <span className="text-xl font-bold text-white">{value}</span>
                </div>
            );

            return (
                <div className="p-4 space-y-4">
                    <h2 className="text-2xl font-bold" style={{ color: COLORS.DARK_GREEN }}>Plant Identifier</h2>
                    
                    <div className="bg-white p-4 rounded-xl shadow-lg border border-gray-200">
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                            Capture or Select Image
                        </label>
                        <input
                            type="file"
                            accept="image/*"
                            onChange={handleFileChange}
                            className="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100"
                        />
                    </div>

                    {imagePreview && (
                        <div className="relative bg-white p-4 rounded-xl shadow-lg border border-gray-200">
                            <img src={imagePreview} alt="Plant Preview" className="w-full h-48 object-cover rounded-lg mb-4 shadow-inner" />
                            
                            <button
                                onClick={handleIdentify}
                                disabled={isIdentifying || !file}
                                className={`w-full py-3 rounded-xl text-white font-bold transition duration-300 shadow-lg ${
                                    isIdentifying ? 'bg-gray-500 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700'
                                }`}
                            >
                                {isIdentifying ? 'Analyzing...' : 'Identify Plant'}
                            </button>
                        </div>
                    )}
                    
                    {message && <p className="text-center text-sm font-medium italic" style={{ color: isIdentifying ? COLORS.BROWN : COLORS.DARK_GREEN }}>{message}</p>}

                    {result && (
                        <div className="bg-white p-4 rounded-xl shadow-lg border-t-4 border-green-500">
                            <h3 className="text-xl font-extrabold mb-3" style={{ color: COLORS.FOREST_GREEN }}>{result.name}</h3>
                            <div className="grid grid-cols-2 gap-3 mb-4">
                                <StatusBlock name="Confidence" value={result.confidence} colorClass="bg-green-600" />
                                <StatusBlock name="Edibility Status" value={result.analysis.includes('Non-edible') ? '⚠️ Caution' : '✅ Edible'} colorClass={result.analysis.includes('Non-edible') ? 'bg-red-500' : 'bg-green-700'} />
                            </div>
                            <p className="text-sm text-gray-700 mb-4 font-semibold">{result.analysis}</p>
                            <p className="text-xs italic text-gray-500">Fun Fact: {result.funFact}</p>
                        </div>
                    )}
                </div>
            );
        };

        const PlantDoctor = ({ diagnosePlant, fileToBase64 }) => {
            const [file, setFile] = useState(null);
            const [imagePreview, setImagePreview] = useState(null);
            const [prompt, setPrompt] = useState("");
            const [isDiagnosing, setIsDiagnosing] = useState(false);
            const [diagnosisResult, setDiagnosisResult] = useState('');

            const handleFileChange = (e) => {
                const selectedFile = e.target.files[0];
                if (selectedFile) {
                    setFile(selectedFile);
                    setImagePreview(URL.createObjectURL(selectedFile));
                    setDiagnosisResult('');
                }
            };

            const handleDiagnose = async () => {
                if (!file) return;

                setIsDiagnosing(true);
                setDiagnosisResult('Diagnosing plant health...');

                try {
                    const base64Image = await fileToBase64(file);
                    const resultText = await diagnosePlant(base64Image, prompt);
                    setDiagnosisResult(resultText);

                } catch (error) {
                    console.error("Diagnosis error:", error);
                    setDiagnosisResult("An error occurred during diagnosis.");
                } finally {
                    setIsDiagnosing(false);
                }
            };

            return (
                <div className="p-4 space-y-4">
                    <h2 className="text-2xl font-bold" style={{ color: COLORS.DARK_GREEN }}>Plant Doctor</h2>
                    <p className="text-sm text-gray-600">Upload a picture of your ailing plant for a diagnosis and care plan from the Rootsage AI.</p>
                    
                    <div className="bg-white p-4 rounded-xl shadow-lg border border-gray-200 space-y-3">
                         <label className="block text-sm font-medium text-gray-700">
                            Capture or Select Image of Ailing Plant
                        </label>
                        <input
                            type="file"
                            accept="image/*"
                            onChange={handleFileChange}
                            className="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-brown-50 file:text-brown-700 hover:file:bg-brown-100"
                            style={{'--tw-bg-opacity': 1, 'backgroundColor': COLORS.SAND, 'color': COLORS.BROWN }}
                        />
                        {imagePreview && (
                            <img src={imagePreview} alt="Ailing Plant Preview" className="w-full h-40 object-contain rounded-lg shadow-inner mt-2" />
                        )}
                    </div>

                    <div className="bg-white p-4 rounded-xl shadow-lg border border-gray-200">
                        <label htmlFor="prompt" className="block text-sm font-medium text-gray-700">
                            Describe the symptoms (optional)
                        </label>
                        <textarea
                            id="prompt"
                            rows="2"
                            value={prompt}
                            onChange={(e) => setPrompt(e.target.value)}
                            className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 sm:text-sm p-2"
                            placeholder="e.g., 'Leaves are yellowing at the tips' or 'There are white spots on the stem.'"
                            disabled={isDiagnosing}
                        />
                        <button
                            onClick={handleDiagnose}
                            disabled={isDiagnosing || !file}
                            className={`mt-3 w-full py-3 rounded-xl text-white font-bold transition duration-300 shadow-md ${
                                isDiagnosing ? 'bg-gray-500 cursor-not-allowed' : 'bg-brown-600 hover:bg-brown-700'
                            }`}
                            style={{ backgroundColor: isDiagnosing ? 'rgb(107 114 128)' : COLORS.BROWN }}
                        >
                            {isDiagnosing ? 'Running Diagnosis...' : 'Get Diagnosis'}
                        </button>
                    </div>

                    {diagnosisResult && (
                        <div className="bg-white p-4 rounded-xl shadow-lg border-t-4 border-brown-500 whitespace-pre-wrap">
                            <h3 className="text-xl font-extrabold mb-3" style={{ color: COLORS.BROWN }}>Diagnosis & Care Plan</h3>
                            <p className="text-sm text-gray-700">{diagnosisResult}</p>
                        </div>
                    )}
                </div>
            );
        };

        const Collectibles = ({ collections, updateScore }) => {
            const handleCollect = () => {
                // Mock function for demonstrating updateScore. In a real app, this would be part of identification.
                updateScore(5);
            };

            return (
                <div className="p-4 space-y-4">
                    <h2 className="text-2xl font-bold" style={{ color: COLORS.DARK_GREEN }}>My Collectibles ({collections.length})</h2>
                    <p className="text-sm text-gray-600">Plants you have successfully identified and saved to your journal.</p>

                    {collections.length === 0 ? (
                        <div className="text-center p-6 bg-white rounded-xl shadow-lg">
                            <LeafIcon className="w-12 h-12 mx-auto text-gray-400" />
                            <p className="mt-3 text-lg font-semibold text-gray-600">No plants collected yet!</p>
                            <p className="text-sm text-gray-500">Head to the Identify tab to start your collection.</p>
                        </div>
                    ) : (
                        <div className="grid grid-cols-2 gap-4">
                            {collections.map((plant, index) => (
                                <div key={index} className="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200">
                                    <img src={plant.imageUrl || "https://placehold.co/100x100/34D399/ffffff?text=P"} alt={plant.name} className="w-full h-24 object-cover" />
                                    <div className="p-3">
                                        <p className="text-sm font-bold truncate" style={{ color: COLORS.DARK_GREEN }}>{plant.name.split('(')[0].trim()}</p>
                                        <p className="text-xs italic text-gray-500 truncate">{plant.name.includes('(') ? plant.name.match(/\(([^)]+)\)/)[1] : 'Unknown species'}</p>
                                        <div className="mt-2 flex items-center justify-between">
                                            <span className="text-xs font-semibold px-2 py-0.5 rounded-full text-white" style={{ backgroundColor: COLORS.FOREST_GREEN }}>
                                                {plant.confidence}
                                            </span>
                                            <span className="text-xs text-gray-500">{new Date(plant.collectedAt?.seconds * 1000).toLocaleDateString()}</span>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const Journal = ({ collections, generateRecipes }) => {
            const [selectedPlant, setSelectedPlant] = useState(null);
            const [recipes, setRecipes] = useState(null);
            const [isGenerating, setIsGenerating] = useState(false);

            const handlePlantSelect = async (plant) => {
                setSelectedPlant(plant);
                setRecipes(null);
                setIsGenerating(true);
                
                try {
                    const plantName = plant.name.split('(')[0].trim();
                    const generatedRecipes = await generateRecipes(plantName);
                    setRecipes(generatedRecipes);
                } catch (error) {
                    console.error("Recipe generation failed:", error);
                    setRecipes([]);
                } finally {
                    setIsGenerating(false);
                }
            };

            const PlantDetailModal = () => {
                if (!selectedPlant) return null;
                const commonName = selectedPlant.name.split('(')[0].trim();
                const scientificName = selectedPlant.name.includes('(') ? selectedPlant.name.match(/\(([^)]+)\)/)[1] : 'Scientific name unknown';

                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 z-20 flex justify-center items-center p-4">
                        <div className="bg-white rounded-2xl max-w-md w-full max-h-[90vh] overflow-y-auto shadow-2xl">
                            <div className="relative">
                                <img src={selectedPlant.imageUrl} alt={commonName} className="w-full h-48 object-cover rounded-t-2xl" />
                                <button onClick={() => setSelectedPlant(null)} className="absolute top-3 right-3 p-2 bg-white rounded-full shadow-lg text-gray-600 hover:text-gray-900">
                                    <CrossIcon className="w-5 h-5" />
                                </button>
                            </div>
                            
                            <div className="p-5">
                                <h3 className="text-2xl font-extrabold mb-1" style={{ color: COLORS.DARK_GREEN }}>{commonName}</h3>
                                <p className="text-sm italic mb-4 text-gray-500">{scientificName}</p>

                                <div className="p-3 mb-4 rounded-xl shadow-inner border" style={{ borderColor: COLORS.SAND }}>
                                    <p className="text-sm font-semibold mb-1" style={{ color: COLORS.BROWN }}>Identification Analysis:</p>
                                    <p className="text-sm text-gray-700">{selectedPlant.analysis}</p>
                                </div>
                                
                                <h4 className="text-xl font-bold mb-3" style={{ color: COLORS.FOREST_GREEN }}>Recipes</h4>

                                {isGenerating && <p className="text-center text-sm italic text-gray-500">Generating 3 recipes with Gemini AI...</p>}
                                
                                {!isGenerating && recipes && recipes.length > 0 && (
                                    <div className="space-y-4">
                                        {recipes.map((recipe, index) => (
                                            <div key={index} className="border-l-4 p-3 rounded-lg shadow-md" style={{ borderColor: COLORS.FOREST_GREEN, backgroundColor: '#f0fdf4' }}>
                                                <p className="font-bold text-base mb-1" style={{ color: COLORS.DARK_GREEN }}>{recipe.recipeName}</p>
                                                <p className="text-xs italic text-gray-600 mb-2">{recipe.description}</p>
                                                <ul className="list-disc pl-5 text-xs text-gray-700">
                                                    {recipe.ingredients.map((ing, i) => <li key={i}>{ing}</li>)}
                                                </ul>
                                            </div>
                                        ))}
                                    </div>
                                )}
                                {!isGenerating && recipes && recipes.length === 0 && (
                                    <p className="text-center text-red-500 text-sm">Could not generate recipes for this plant.</p>
                                )}
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="p-4 space-y-4">
                    <h2 className="text-2xl font-bold" style={{ color: COLORS.DARK_GREEN }}>Forager's Journal</h2>
                    <p className="text-sm text-gray-600">Tap a plant to view its analysis and generate AI-powered recipes.</p>

                    <div className="space-y-3">
                        {collections.length === 0 ? (
                            <div className="text-center p-6 bg-white rounded-xl shadow-lg">
                                <BookIcon className="w-12 h-12 mx-auto text-gray-400" />
                                <p className="mt-3 text-lg font-semibold text-gray-600">Journal is Empty</p>
                                <p className="text-sm text-gray-500">Start collecting plants to fill your journal.</p>
                            </div>
                        ) : (
                            collections.map((plant, index) => (
                                <div
                                    key={index}
                                    onClick={() => handlePlantSelect(plant)}
                                    className="flex items-center bg-white p-3 rounded-xl shadow-md border-l-4 cursor-pointer hover:shadow-lg transition duration-200"
                                    style={{ borderColor: COLORS.FOREST_GREEN }}
                                >
                                    <img src={plant.imageUrl || "https://placehold.co/100x100/34D399/ffffff?text=P"} alt={plant.name} className="w-16 h-16 object-cover rounded-lg mr-4" />
                                    <div className="flex-grow">
                                        <p className="text-base font-bold truncate" style={{ color: COLORS.DARK_GREEN }}>{plant.name.split('(')[0].trim()}</p>
                                        <p className="text-xs italic text-gray-500 truncate">{plant.name.includes('(') ? plant.name.match(/\(([^)]+)\)/)[1] : 'Unknown species'}</p>
                                        <span className="text-xs text-gray-500">Collected: {new Date(plant.collectedAt?.seconds * 1000).toLocaleDateString()}</span>
                                    </div>
                                    <button className="text-green-600 p-2 ml-2 hover:bg-green-50 rounded-full">
                                        <BookIcon className="w-5 h-5" />
                                    </button>
                                </div>
                            ))
                        )}
                    </div>
                    <PlantDetailModal />
                </div>
            );
        };

        const Quests = ({ collections }) => {
            const getQuestStatus = (quest) => {
                if (quest.status === 'Locked') return 'Locked';
                const count = collections.filter(c => c.name.includes(quest.requiredCollectible)).length;
                if (quest.id === 'q4') { // Year-Round: Identify 10 Fungi
                    const fungiCount = collections.filter(c => c.name.toLowerCase().includes('fungi') || c.name.toLowerCase().includes('mushroom')).length;
                    if (fungiCount >= 10) return 'Completed';
                }
                
                // Simple check for existence of required collectible
                if (collections.some(c => c.name.includes(quest.requiredCollectible))) {
                    return 'Completed';
                }

                return 'In Progress';
            };

            const getProgressText = (quest) => {
                if (quest.status === 'Locked') return 'Requires completing previous seasonal quest.';
                if (quest.id === 'q4') {
                    const fungiCount = collections.filter(c => c.name.toLowerCase().includes('fungi') || c.name.toLowerCase().includes('mushroom')).length;
                    return `Progress: ${fungiCount}/10 Fungi Identified`;
                }
                if (getQuestStatus(quest) === 'Completed') return 'Quest Complete!';
                return `Required: Find ${quest.requiredCollectible}`;
            };

            const getStatusColor = (status) => {
                switch (status) {
                    case 'Completed': return 'bg-green-500';
                    case 'In Progress': return 'bg-yellow-500';
                    case 'Locked': return 'bg-gray-400';
                    default: return 'bg-gray-200';
                }
            };

            return (
                <div className="p-4 space-y-4">
                    <h2 className="text-2xl font-bold" style={{ color: COLORS.DARK_GREEN }}>Seasonal Quests</h2>
                    <p className="text-sm text-gray-600">Complete these challenges to earn rare badges and boost your score!</p>

                    <div className="space-y-4">
                        {MOCK_SEASONAL_QUESTS.map((quest) => {
                            const status = getQuestStatus(quest);
                            const progressText = getProgressText(quest);
                            return (
                                <div key={quest.id} className="bg-white p-4 rounded-xl shadow-lg border border-gray-200">
                                    <div className="flex items-center justify-between mb-2">
                                        <div className="flex items-center">
                                            <span className="text-2xl mr-3">{quest.badge}</span>
                                            <div>
                                                <p className="font-bold" style={{ color: COLORS.DARK_GREEN }}>{quest.name}</p>
                                                {quest.caution && <span className="text-xs font-semibold text-red-500">⚠️ Caution Required</span>}
                                            </div>
                                        </div>
                                        <span className={`px-3 py-1 text-xs font-semibold rounded-full text-white ${getStatusColor(status)}`}>
                                            {status}
                                        </span>
                                    </div>
                                    <div className="w-full bg-gray-200 rounded-full h-1.5 mt-2">
                                        <div
                                            className={`h-1.5 rounded-full ${status === 'Completed' ? 'bg-green-500' : status === 'In Progress' ? 'bg-yellow-500' : 'bg-gray-400'}`}
                                            style={{ width: status === 'Completed' ? '100%' : '50%' }}
                                        ></div>
                                    </div>
                                    <p className="text-xs text-gray-500 mt-2">{progressText}</p>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };
        
        const Profile = ({ userData, collections, signOutUser, signInWithGoogle, user }) => {
            const tier = getBadgeTier(collections.length);
            const nextTierText = tier.nextTier > collections.length ? `Collect ${tier.nextTier - collections.length} more to reach the next tier!` : 'You have reached the highest tier!';

            const AuthBlock = () => (
                <div className="mt-4 p-4 bg-white rounded-xl shadow-lg border border-gray-200">
                    <h3 className="text-lg font-bold mb-3" style={{ color: COLORS.DARK_GREEN }}>Account</h3>
                    {user ? (
                        <div className="space-y-2">
                            <p className="text-sm text-gray-700">Signed in as: <span className="font-semibold">{user.email || userData.displayName}</span></p>
                            <button
                                onClick={signOutUser}
                                className="w-full py-2 rounded-xl text-white font-bold bg-red-500 hover:bg-red-600 transition duration-200 flex items-center justify-center"
                            >
                                <LoginIcon className="w-5 h-5 rotate-180 mr-2" /> Sign Out
                            </button>
                        </div>
                    ) : (
                        <div className="space-y-2">
                             <p className="text-sm text-gray-700">Sign in to save your progress permanently.</p>
                            <button
                                onClick={signInWithGoogle}
                                className="w-full py-2 rounded-xl text-white font-bold bg-blue-500 hover:bg-blue-600 transition duration-200 flex items-center justify-center"
                            >
                                <LoginIcon className="w-5 h-5 mr-2" /> Sign In with Google
                            </button>
                            <p className="text-xs text-center text-gray-500">Currently using anonymous/guest profile.</p>
                        </div>
                    )}
                </div>
            );

            return (
                <div className="p-4 space-y-4">
                    <h2 className="text-2xl font-bold" style={{ color: COLORS.DARK_GREEN }}>My Foraging Profile</h2>
                    
                    {userData && (
                        <div className="bg-white p-4 rounded-xl shadow-lg border border-gray-200 space-y-4">
                            <div className="flex items-center space-x-4">
                                <img src={user?.photoURL || defaultProfile.profilePicUrl} alt="Profile" className="w-20 h-20 object-cover rounded-full border-4" style={{ borderColor: COLORS.FOREST_GREEN }} />
                                <div>
                                    <p className="text-xl font-bold" style={{ color: COLORS.DARK_GREEN }}>{userData.displayName}</p>
                                    <p className="text-sm text-gray-600">{userData.bio}</p>
                                </div>
                            </div>

                            <div className="grid grid-cols-2 gap-3 text-center">
                                <div className="p-3 rounded-lg shadow-inner border border-gray-100" style={{ backgroundColor: COLORS.SAND }}>
                                    <p className="text-xs font-medium text-gray-700">Total Score</p>
                                    <p className="text-2xl font-extrabold" style={{ color: COLORS.DARK_GREEN }}>{userData.score || 0}</p>
                                </div>
                                <div className="p-3 rounded-lg shadow-inner border border-gray-100" style={{ backgroundColor: COLORS.SAND }}>
                                    <p className="text-xs font-medium text-gray-700">Plants Collected</p>
                                    <p className="text-2xl font-extrabold" style={{ color: COLORS.DARK_GREEN }}>{collections.length}</p>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="bg-white p-4 rounded-xl shadow-lg border-l-4 border-amber-500">
                        <h3 className="text-lg font-bold mb-2" style={{ color: COLORS.BROWN }}>{tier.icon} {tier.name}</h3>
                        <p className="text-sm text-gray-700">{nextTierText}</p>
                    </div>

                    <AuthBlock />
                </div>
            );
        };

        // --- Main App Component ---
        const App = () => {
            // New Firebase Hooks from index (3).html
            const { user, isAuthReady, dbInstance, signInWithGoogle, signOutUser, userId } = useAuth();
            const { userData, updateScore } = useUserData(userId, dbInstance, isAuthReady);
            const { collections, loading: collectionsLoading, addPlantToCollection } = useCollections(dbInstance, isAuthReady, userId);

            // State from index (2).html
            const [isAgreed, setIsAgreed] = useState(false);
            const [showPreloader, setShowPreloader] = useState(true); // Visual preloader status
            const [currentPage, setCurrentPage] = useState('identify');
            
            // Effect to manage the preloader visual timeout
            useEffect(() => {
                // The BouncingLogoPreloader has its own internal timeout
                // We'll let it run and set showPreloader to false
            }, []); 

            // Wait for agreement, preloader timeout, and Firebase Auth readiness
            if (!isAgreed) return <AgreementGate onAgree={() => setIsAgreed(true)} />;
            if (showPreloader || !isAuthReady || !userData) {
                // userData check ensures we have the profile data loaded or created
                return <BouncingLogoPreloader onAnimationEnd={setShowPreloader} />;
            }
            
            // Props to pass to all page components
            const pageProps = {
                // Firebase/Data
                collections: collections,
                addPlantToCollection: addPlantToCollection,
                updateScore: updateScore,
                userData: userData,
                user: user,
                signOutUser: signOutUser,
                signInWithGoogle: signInWithGoogle,

                // Gemini API helpers
                generateRecipes,
                identifyPlant,
                diagnosePlant,
                fileToBase64,
            };

            const renderAppContent = () => {
                let content;
                switch (currentPage) {
                    case 'doctor':
                        content = <PlantDoctor {...pageProps} />;
                        break;
                    case 'collectibles':
                        content = <Collectibles {...pageProps} />;
                        break;
                    case 'journal':
                        content = <Journal {...pageProps} />;
                        break;
                    case 'quests':
                        content = <Quests {...pageProps} />;
                        break;
                    case 'profile':
                        content = <Profile {...pageProps} />;
                        break;
                    case 'identify':
                    default:
                        content = <IdentifyPlant {...pageProps} />;
                }
                
                return (
                    <div style={{ backgroundColor: COLORS.SAND }} className="min-h-screen font-sans pb-20">
                        <div className="max-w-md mx-auto min-h-screen">
                            <header className="sticky top-0 shadow-md p-4 z-10" style={{ backgroundColor: COLORS.SAND }}>
                                <h1 className="text-3xl font-extrabold text-center" style={{ color: COLORS.DARK_GREEN }}>Rootsage</h1>
                            </header>
                            <main>{content}</main>
                        </div>
                        <NavBar currentPage={currentPage} setCurrentPage={setCurrentPage} badgeCount={collections.length} />
                    </div>
                );
            };

            return renderAppContent();
        };

        // Render the application to the root div
        ReactDOM.render(<App />, document.getElementById('root'));

    </script>
</body>
</html>
