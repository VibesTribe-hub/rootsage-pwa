<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RootSage Plant Identifier (PWA)</title>
    <!-- PWA Requirements: Define how the app should look on a home screen -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="theme-color" content="#10b981">
    
    <!-- Load Tailwind CSS, React, ReactDOM, and Babel -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel is needed to compile JSX in the browser for this single-file setup -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide icons for React -->
    <script src="https://unpkg.com/lucide-react@latest/dist/umd/lucide-react.js"></script>
    
    <!-- Firebase SDK Imports and Setup -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Hardcoded config provided by the user
        const hardcodedConfig = {
            apiKey: "AIzaSyBMoKi_lHpD-bm3lLuVOQo1TQmzm6ztmOc",
            authDomain: "rootsage-93b81.firebaseapp.com",
            projectId: "rootsage-93b81",
            storageBucket: "rootsage-93b81.firebasestorage.app",
            messagingSenderId: "1030097757643",
            appId: "1:1030097757643:web:60af064ed2e83c78fd824e"
        };
        
        // Use environment variable if available, otherwise use hardcoded config
        const firebaseConfig = (typeof __firebase_config !== 'undefined' && __firebase_config)
            ? JSON.parse(__firebase_config)
            : hardcodedConfig;

        // Use environment variable for App ID and Auth Token
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'rootsage-default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase services
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Set logging level for debugging Firebase operations
        setLogLevel('Debug');

        // Expose Firebase and context variables to the global scope for the React app (running in Babel script)
        window.firebaseApp = app;
        window.db = db;
        window.auth = auth;
        window.appId = appId;
        window.initialAuthToken = initialAuthToken;
        window.onAuthStateChanged = onAuthStateChanged;
        window.signInAnonymously = signInAnonymously;
        window.signInWithCustomToken = signInWithCustomToken;
        window.collection = collection;
        window.query = query;
        window.onSnapshot = onSnapshot;

    </script>
    
    <style>
        /* Custom styles for better aesthetics and mobile view */
        body, #root {
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            font-family: 'Inter', sans-serif;
            background-color: #f0fdf4; /* Light green background */
        }
        /* Mobile-first approach: constrain max width for desktop experience */
        .app-container {
            max-width: 420px; /* Standard mobile width */
            margin: 0 auto;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            height: 100%;
        }
        /* Style for the centered splash page content */
        .splash-content {
            background: linear-gradient(180deg, #d1fae5 0%, #10b981 100%);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;
        const { IconCamera, IconLeaf, IconGalleryHorizontal, IconBookOpen, IconUser, IconHome, IconChevronLeft, IconAlertTriangle, IconLoader2, IconCircleCheck } = lucide;

        // --- Firebase Context and Constants ---
        const PAGES = {
            SPLASH: 'splash',
            HOME: 'home',
            CAMERA: 'camera',
            LIBRARY: 'library',
            PROFILE: 'profile',
            IDENTIFYING: 'identifying',
            RESULT: 'result',
            DISCLAIMER: 'disclaimer',
        };

        const RootSageContext = React.createContext();

        // --- Utility Components ---
        const Loading = () => (
            <div className="flex flex-col items-center justify-center p-8">
                <IconLoader2 className="w-8 h-8 text-green-600 animate-spin" />
                <p className="mt-2 text-sm text-gray-600">Loading...</p>
            </div>
        );

        const Button = ({ children, onClick, variant = 'primary', icon: Icon, disabled = false, className = '' }) => {
            let baseClasses = "flex items-center justify-center rounded-xl font-semibold transition duration-150 ease-in-out shadow-lg";
            let colorClasses = "";

            switch (variant) {
                case 'primary':
                    colorClasses = "bg-green-600 hover:bg-green-700 text-white focus:ring-4 focus:ring-green-500/50";
                    break;
                case 'secondary':
                    colorClasses = "bg-white hover:bg-gray-100 text-green-600 border border-green-600 focus:ring-4 focus:ring-green-200";
                    break;
                case 'danger':
                    colorClasses = "bg-red-500 hover:bg-red-600 text-white focus:ring-4 focus:ring-red-400/50";
                    break;
                case 'link':
                    baseClasses = "text-green-600 hover:text-green-700 font-medium";
                    colorClasses = "";
                    break;
            }

            const paddingClasses = variant === 'link' ? 'p-1' : 'py-3 px-6';
            const disabledClasses = disabled ? 'opacity-50 cursor-not-allowed' : '';

            return (
                <button
                    onClick={onClick}
                    disabled={disabled}
                    className={`${baseClasses} ${colorClasses} ${paddingClasses} ${disabledClasses} ${className}`}
                >
                    {Icon && <Icon className={`w-5 h-5 ${children ? 'mr-2' : ''}`} />}
                    {children}
                </button>
            );
        };

        const Card = ({ children, className = '' }) => (
            <div className={`bg-white p-5 rounded-2xl shadow-xl ${className}`}>
                {children}
            </div>
        );

        // --- Firebase/Auth Context Provider ---
        const FirebaseProvider = ({ children }) => {
            const [authState, setAuthState] = useState({
                user: null,
                userId: null,
                isReady: false,
            });
            const [dbInstance, setDbInstance] = useState(null);
            const [appId, setAppId] = useState(null);

            useEffect(() => {
                // Initialize Firebase services exposed to window object by the module script
                const { db, auth, appId: envAppId, initialAuthToken, onAuthStateChanged, signInAnonymously, signInWithCustomToken } = window;
                
                if (!db || !auth) {
                    console.error("Firebase services are not initialized on the window object.");
                    setAuthState(s => ({ ...s, isReady: true }));
                    return;
                }

                setDbInstance(db);
                setAppId(envAppId);

                // 1. Initial Authentication (Mandatory environment check)
                const authenticate = async () => {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            // If no custom token, sign in anonymously
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Firebase Auth error:", error);
                        // Fallback to anonymous sign-in if custom token fails
                        try {
                            await signInAnonymously(auth);
                        } catch (anonError) {
                            console.error("Anonymous sign-in failed:", anonError);
                        }
                    }
                };

                // 2. Set up Auth State Listener
                const unsubscribe = onAuthStateChanged(auth, (user) => {
                    let currentUserId = user ? user.uid : (window.crypto.randomUUID ? window.crypto.randomUUID() : 'anonymous-' + Date.now());
                    
                    setAuthState({
                        user,
                        userId: currentUserId,
                        isReady: true,
                    });
                });
                
                // Perform initial authentication if listener hasn't been triggered yet
                if (!auth.currentUser) {
                    authenticate();
                }

                // Cleanup subscription
                return () => unsubscribe();
            }, []); // Run only once on mount

            const value = useMemo(() => ({
                ...authState,
                db: dbInstance,
                appId,
            }), [authState, dbInstance, appId]);

            // Wait until authentication status is determined
            if (!authState.isReady) {
                return (
                    <div className="h-screen flex items-center justify-center bg-gray-50">
                        <Loading />
                    </div>
                );
            }

            return (
                <RootSageContext.Provider value={value}>
                    {children}
                </RootSageContext.Provider>
            );
        };
        
        // Custom hook to use the context
        const useRootSage = () => React.useContext(RootSageContext);


        // --- Firestore Data Hook ---
        const useFirestoreCollection = (collectionName) => {
            const { db, userId, appId, isReady } = useRootSage();
            const [data, setData] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [error, setError] = useState(null);

            useEffect(() => {
                if (!db || !isReady || !userId || !appId) return;

                const dbCollection = window.collection(db, `/artifacts/${appId}/users/${userId}/${collectionName}`);
                const q = window.query(dbCollection);

                // Real-time listener
                const unsubscribe = window.onSnapshot(q, (snapshot) => {
                    const items = [];
                    snapshot.forEach((doc) => {
                        items.push({ id: doc.id, ...doc.data() });
                    });
                    setData(items);
                    setIsLoading(false);
                    setError(null);
                }, (err) => {
                    console.error("Firestore error:", err);
                    setError(err.message);
                    setIsLoading(false);
                });

                // Cleanup function
                return () => unsubscribe();
            }, [db, userId, appId, isReady, collectionName]);

            return { data, isLoading, error };
        };
        
        // --- Page Components ---

        const SplashPage = ({ setCurrentPage }) => {
            useEffect(() => {
                // Automatically transition to the Disclaimer page after 2 seconds
                const timer = setTimeout(() => {
                    setCurrentPage(PAGES.DISCLAIMER);
                }, 2000); 
                return () => clearTimeout(timer);
            }, [setCurrentPage]);

            return (
                <div className="splash-content flex flex-col items-center justify-center h-full w-full p-8 text-white">
                    <IconLeaf className="w-24 h-24 text-white animate-bounce" />
                    <h1 className="text-4xl font-extrabold mt-4 drop-shadow-lg">RootSage</h1>
                    <p className="text-lg mt-2 font-medium">Your Personal Plant Identifier</p>
                </div>
            );
        };

        const DisclaimerPage = ({ setCurrentPage }) => {
            return (
                <div className="flex flex-col h-full p-6">
                    <header className="py-4 text-center">
                        <h2 className="text-2xl font-bold text-red-600 flex items-center justify-center">
                            <IconAlertTriangle className="w-6 h-6 mr-2" /> Important Disclaimer
                        </h2>
                    </header>
                    <Card className="flex-grow overflow-y-auto mb-6">
                        <p className="text-sm text-gray-700 mb-4">
                            RootSage provides plant identification and care information for informational and educational purposes only.
                        </p>
                        <ul className="list-disc list-inside text-sm text-gray-600 space-y-2">
                            <li>**Toxicity:** We do not guarantee accurate toxicity identification. **NEVER** consume a plant based on this app's result. Always consult a professional.</li>
                            <li>**Medical Advice:** This information is not a substitute for professional medical or veterinary advice.</li>
                            <li>**Accuracy:** Identification accuracy depends on image quality and plant condition. Treat results as suggestive, not definitive.</li>
                            <li>**Pest/Disease:** Information on pests and diseases is general and should be verified by a certified arborist or horticulturist.</li>
                        </ul>
                        <p className="text-sm text-red-600 mt-4 font-semibold">
                            By continuing, you acknowledge that you will not hold the developers responsible for any harm, loss, or consequences resulting from the use of the information provided by this application.
                        </p>
                    </Card>
                    <Button onClick={() => setCurrentPage(PAGES.HOME)} className="w-full">
                        I Understand and Accept
                    </Button>
                </div>
            );
        };
        
        const HomePage = ({ setCurrentPage }) => {
            const { data: identifications, isLoading } = useFirestoreCollection('identifications');
            const { userId } = useRootSage();
            
            // Placeholder for plant data if Firestore is empty/loading
            const recentPlants = identifications.slice(0, 3); 

            const PlantItem = ({ plant }) => (
                <div className="p-4 bg-gray-50 rounded-xl flex items-start space-x-3 shadow-md border border-gray-200">
                    <img 
                        src={plant.imageUrl || "https://placehold.co/60x60/d1fae5/10b981?text=PLANT"} 
                        alt={plant.name || "Identified Plant"}
                        className="w-16 h-16 object-cover rounded-lg"
                        onError={(e) => { e.target.onerror = null; e.target.src="https://placehold.co/60x60/d1fae5/10b981?text=PLANT" }}
                    />
                    <div className="flex-grow">
                        <h3 className="font-bold text-green-700">{plant.name || "Unknown Species"}</h3>
                        <p className="text-xs text-gray-500 italic">{plant.scientificName || "No scientific name available"}</p>
                        <p className="text-sm mt-1 text-gray-600 line-clamp-2">{plant.description || "A recently identified plant."}</p>
                    </div>
                </div>
            );

            return (
                <div className="p-4 space-y-6">
                    <Card>
                        <h2 className="text-2xl font-bold text-green-800 mb-3">Welcome Back!</h2>
                        <p className="text-gray-600">
                            Ready to discover a new species? Tap the Camera button to begin identification.
                        </p>
                        <div className="mt-4 flex space-x-4">
                            <Button 
                                onClick={() => setCurrentPage(PAGES.CAMERA)}
                                icon={IconCamera}
                                className="flex-1"
                            >
                                Identify Now
                            </Button>
                        </div>
                    </Card>

                    <Card>
                        <h2 className="text-xl font-bold text-green-700 mb-4 flex items-center">
                            <IconBookOpen className="w-5 h-5 mr-2" /> Recent Finds
                        </h2>
                        {isLoading ? (
                            <Loading />
                        ) : recentPlants.length > 0 ? (
                            <div className="space-y-3">
                                {recentPlants.map((plant) => (
                                    <PlantItem key={plant.id} plant={plant} />
                                ))}
                                <Button 
                                    onClick={() => setCurrentPage(PAGES.LIBRARY)}
                                    variant="link"
                                    className="w-full mt-2"
                                >
                                    View All {identifications.length} Identifications
                                </Button>
                            </div>
                        ) : (
                            <p className="text-gray-500 text-sm">
                                No recent identifications found. Go identify your first plant!
                            </p>
                        )}
                    </Card>
                    
                    <div className="text-center text-xs text-gray-400 p-2 border-t border-gray-100">
                        <p>User ID: {userId}</p>
                    </div>
                </div>
            );
        };
        
        const CameraPage = ({ setCurrentPage, setIdentificationResult }) => {
            const [selectedImage, setSelectedImage] = useState(null);
            const [imagePreview, setImagePreview] = useState(null);
            const [isIdentifying, setIsIdentifying] = useState(false);
            
            const handleImageChange = (event) => {
                const file = event.target.files[0];
                if (file) {
                    setSelectedImage(file);
                    setImagePreview(URL.createObjectURL(file));
                }
            };

            const identifyPlant = async () => {
                if (!selectedImage) return;

                setIsIdentifying(true);
                setCurrentPage(PAGES.IDENTIFYING);

                const reader = new FileReader();
                reader.readAsDataURL(selectedImage);
                reader.onloadend = async () => {
                    const base64Image = reader.result.split(',')[1];
                    await callGeminiForIdentification(base64Image);
                };
            };
            
            const callGeminiForIdentification = async (base64Image) => {
                const prompt = "Identify the plant in this image. Provide a JSON object containing the following structure: { name: string, scientificName: string, description: string (3 sentences max), careTips: array of 3 strings (bullet points), isToxic: boolean, imageUrl: string (use a high-quality placeholder image url for now: https://placehold.co/100x100/10b981/ffffff?text=Plant) }. If you cannot identify it, set 'name' to 'Unidentified Plant' and all other fields to null or false.";
                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                const payload = {
                    contents: [
                        {
                            role: "user",
                            parts: [
                                { text: prompt },
                                {
                                    inlineData: {
                                        mimeType: selectedImage.type,
                                        data: base64Image
                                    }
                                }
                            ]
                        }
                    ],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                name: { type: "STRING" },
                                scientificName: { type: "STRING" },
                                description: { type: "STRING" },
                                careTips: { type: "ARRAY", items: { type: "STRING" } },
                                isToxic: { type: "BOOLEAN" },
                                imageUrl: { type: "STRING" }
                            },
                            propertyOrdering: ["name", "scientificName", "description", "careTips", "isToxic", "imageUrl"]
                        }
                    }
                };
                
                // Retry logic implementation (exponential backoff)
                const maxRetries = 5;
                let currentDelay = 1000;
                
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            throw new Error(`API returned status ${response.status}`);
                        }

                        const result = await response.json();
                        
                        const jsonText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (jsonText) {
                            const parsedJson = JSON.parse(jsonText);
                            // Store the result and navigate
                            setIdentificationResult(parsedJson);
                            setCurrentPage(PAGES.RESULT);
                            setIsIdentifying(false);
                            return;
                        }
                        throw new Error("Invalid response format from Gemini API.");
                        
                    } catch (error) {
                        console.error(`Attempt ${i + 1} failed:`, error);
                        if (i === maxRetries - 1) {
                            // Last attempt failed
                            setIdentificationResult({ name: "Error", description: "Failed to identify the plant due to a network or processing error. Please try again." });
                            setCurrentPage(PAGES.RESULT);
                            setIsIdentifying(false);
                            return;
                        }
                        await new Promise(resolve => setTimeout(resolve, currentDelay));
                        currentDelay *= 2; // Exponential backoff
                    }
                }
            };


            return (
                <div className="flex flex-col h-full p-4 space-y-4">
                    <Card className="flex-1 flex flex-col items-center justify-center">
                        <input
                            type="file"
                            accept="image/*"
                            capture="environment"
                            id="image-capture"
                            className="hidden"
                            onChange={handleImageChange}
                            disabled={isIdentifying}
                        />
                        
                        {imagePreview ? (
                            <div className="w-full h-64 border-4 border-dashed border-green-300 rounded-2xl overflow-hidden relative">
                                <img src={imagePreview} alt="Plant Preview" className="w-full h-full object-cover" />
                                <div className="absolute top-2 right-2">
                                    <Button 
                                        onClick={() => document.getElementById('image-capture').click()} 
                                        variant="secondary"
                                        className="p-2 h-10 w-10 text-xs rounded-full"
                                        icon={IconCamera}
                                    >
                                    </Button>
                                </div>
                            </div>
                        ) : (
                            <label 
                                htmlFor="image-capture" 
                                className="w-full h-64 flex flex-col items-center justify-center bg-gray-50 border-4 border-dashed border-green-300 rounded-2xl cursor-pointer hover:bg-green-50 transition"
                            >
                                <IconCamera className="w-10 h-10 text-green-500" />
                                <p className="mt-2 text-sm font-medium text-green-600">Tap to Take or Select Photo</p>
                                <p className="text-xs text-gray-400">For best results, focus on a leaf or flower.</p>
                            </label>
                        )}
                    </Card>
                    
                    <Button 
                        onClick={identifyPlant}
                        disabled={!selectedImage || isIdentifying}
                        icon={isIdentifying ? IconLoader2 : IconLeaf}
                        className="w-full mt-4"
                    >
                        {isIdentifying ? "Identifying..." : "Identify Plant"}
                    </Button>
                    <Button 
                        onClick={() => setCurrentPage(PAGES.HOME)}
                        variant="secondary"
                        className="w-full"
                        disabled={isIdentifying}
                    >
                        Cancel
                    </Button>
                </div>
            );
        };
        
        const IdentifyingPage = () => (
            <div className="flex flex-col items-center justify-center h-full p-8 text-center">
                <IconLoader2 className="w-16 h-16 text-green-600 animate-spin" />
                <h2 className="text-2xl font-bold text-green-700 mt-4">Analyzing Flora...</h2>
                <p className="text-gray-500 mt-2">Please wait while RootSage consults its botanical library.</p>
                <div className="mt-6 text-sm text-gray-400">
                    This uses Gemini's vision model to provide accurate results.
                </div>
            </div>
        );

        const ResultPage = ({ setCurrentPage, identificationResult }) => {
            const { db, appId, userId } = useRootSage();
            const [isSaving, setIsSaving] = useState(false);
            const [saveStatus, setSaveStatus] = useState(null); // 'success', 'error', null

            const isIdentified = identificationResult && identificationResult.name !== 'Unidentified Plant' && identificationResult.name !== 'Error';

            const saveIdentification = async () => {
                if (!db || !isIdentified) return;

                setIsSaving(true);
                setSaveStatus(null);
                
                try {
                    // Path: /artifacts/{appId}/users/{userId}/identifications
                    const collectionRef = window.collection(db, `/artifacts/${appId}/users/${userId}/identifications`);
                    
                    const docData = {
                        ...identificationResult,
                        timestamp: Date.now(),
                    };
                    
                    // We use addDoc to create a new document with an auto-generated ID
                    const { addDoc } = window;
                    await addDoc(collectionRef, docData);

                    setSaveStatus('success');
                    
                } catch (error) {
                    console.error("Error saving identification:", error);
                    setSaveStatus('error');
                } finally {
                    setIsSaving(false);
                }
            };
            
            const handleFinish = () => {
                setCurrentPage(PAGES.HOME);
            };

            const ToxicityTag = ({ isToxic }) => (
                <span className={`inline-flex items-center px-3 py-1 text-xs font-semibold rounded-full ${isToxic ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>
                    {isToxic ? <IconAlertTriangle className="w-4 h-4 mr-1" /> : <IconCircleCheck className="w-4 h-4 mr-1" />}
                    {isToxic ? "Potentially Toxic" : "Generally Safe"}
                </span>
            );

            return (
                <div className="p-4 space-y-4">
                    <Card>
                        <div className="flex items-start space-x-4 mb-4">
                            <img 
                                src={identificationResult.imageUrl || "https://placehold.co/100x100/d1fae5/10b981?text=PLANT"} 
                                alt={identificationResult.name || "Identification Result"}
                                className="w-24 h-24 object-cover rounded-xl shadow-md"
                                onError={(e) => { e.target.onerror = null; e.target.src="https://placehold.co/100x100/d1fae5/10b981?text=PLANT" }}
                            />
                            <div>
                                <h2 className="text-2xl font-extrabold text-green-800">{identificationResult.name || "Unknown Result"}</h2>
                                {isIdentified && <p className="text-sm italic text-gray-500">{identificationResult.scientificName}</p>}
                                {isIdentified && <ToxicityTag isToxic={identificationResult.isToxic} />}
                            </div>
                        </div>

                        <div className="border-t border-gray-100 pt-4">
                            <h3 className="text-lg font-semibold text-green-700 mb-2">Description</h3>
                            <p className="text-gray-700 text-sm">{identificationResult.description || "No description available."}</p>
                        </div>
                        
                        {isIdentified && (
                            <div className="mt-4">
                                <h3 className="text-lg font-semibold text-green-700 mb-2">Basic Care Tips</h3>
                                <ul className="space-y-1 text-sm text-gray-700 list-disc list-inside">
                                    {identificationResult.careTips && identificationResult.careTips.length > 0 ? (
                                        identificationResult.careTips.map((tip, index) => <li key={index}>{tip}</li>)
                                    ) : (
                                        <li>No specific care tips found.</li>
                                    )}
                                </ul>
                            </div>
                        )}
                        
                    </Card>

                    <div className="mt-6 flex flex-col space-y-3">
                        {isIdentified && (
                            <Button 
                                onClick={saveIdentification}
                                disabled={isSaving || saveStatus === 'success'}
                                icon={saveStatus === 'success' ? IconCircleCheck : IconBookOpen}
                                className="w-full"
                            >
                                {isSaving ? "Saving..." : saveStatus === 'success' ? "Saved to Library!" : "Save to Library"}
                            </Button>
                        )}
                        {saveStatus === 'error' && <p className="text-red-500 text-sm text-center">Failed to save. Try again.</p>}

                        <Button 
                            onClick={handleFinish}
                            variant="secondary"
                            className="w-full"
                        >
                            Back to Home
                        </Button>
                    </div>
                </div>
            );
        };

        const LibraryPage = ({ setCurrentPage }) => {
            const { data: identifications, isLoading } = useFirestoreCollection('identifications');

            const PlantItem = ({ plant }) => (
                <Card className="flex items-start space-x-4">
                    <img 
                        src={plant.imageUrl || "https://placehold.co/80x80/d1fae5/10b981?text=PLANT"} 
                        alt={plant.name || "Identified Plant"}
                        className="w-20 h-20 object-cover rounded-lg flex-shrink-0"
                        onError={(e) => { e.target.onerror = null; e.target.src="https://placehold.co/80x80/d1fae5/10b981?text=PLANT" }}
                    />
                    <div className="flex-grow">
                        <h3 className="font-bold text-green-700 text-lg">{plant.name || "Unknown Species"}</h3>
                        <p className="text-xs text-gray-500 italic mb-2">{plant.scientificName || "No scientific name available"}</p>
                        <p className={`text-sm line-clamp-2 ${plant.isToxic ? 'text-red-600' : 'text-gray-600'}`}>
                            {plant.isToxic ? <IconAlertTriangle className="w-4 h-4 inline mr-1" /> : ''}
                            {plant.description || "A recently identified plant."}
                        </p>
                    </div>
                </Card>
            );

            return (
                <div className="p-4 space-y-4">
                    <h2 className="text-3xl font-bold text-green-800 mb-4">My Plant Library</h2>
                    {isLoading ? (
                        <Loading />
                    ) : identifications.length === 0 ? (
                        <Card>
                            <p className="text-gray-500 text-center py-8">
                                Your library is empty! Start identifying plants to fill it up.
                            </p>
                        </Card>
                    ) : (
                        <div className="space-y-4">
                            {identifications.sort((a, b) => b.timestamp - a.timestamp).map((plant) => (
                                <PlantItem key={plant.id} plant={plant} />
                            ))}
                        </div>
                    )}
                </div>
            );
        };
        
        const ProfilePage = () => {
            const { userId } = useRootSage();
            const { data: identifications, isLoading } = useFirestoreCollection('identifications');

            return (
                <div className="p-4 space-y-6">
                    <h2 className="text-3xl font-bold text-green-800 mb-4">My Profile</h2>
                    
                    <Card>
                        <h3 className="text-xl font-semibold text-green-700 mb-2">User Details</h3>
                        <div className="space-y-1 text-sm">
                            <p><span className="font-medium text-gray-600">Account Status:</span> Anonymous</p>
                            <p className="break-all"><span className="font-medium text-gray-600">Your ID:</span> {userId}</p>
                            <p className="text-xs text-gray-400 mt-2">This ID is used to securely store your data in your private library.</p>
                        </div>
                    </Card>

                    <Card>
                        <h3 className="text-xl font-semibold text-green-700 mb-2">App Statistics</h3>
                        {isLoading ? (
                            <Loading />
                        ) : (
                            <div className="grid grid-cols-2 gap-4">
                                <div className="p-3 bg-green-50 rounded-lg text-center">
                                    <p className="text-3xl font-bold text-green-800">{identifications.length}</p>
                                    <p className="text-sm text-green-600">Identifications</p>
                                </div>
                                <div className="p-3 bg-green-50 rounded-lg text-center">
                                    <p className="text-3xl font-bold text-green-800">
                                        {identifications.filter(p => p.isToxic).length}
                                    </p>
                                    <p className="text-sm text-green-600">Toxic Plants Found</p>
                                </div>
                            </div>
                        )}
                    </Card>

                    <div className="pt-4 border-t border-gray-200">
                        <Button variant="danger" className="w-full">
                            Sign Out (Coming Soon)
                        </Button>
                    </div>
                </div>
            );
        };

        // --- Navigation Bar ---
        const NavBar = ({ currentPage, setCurrentPage }) => {
            const navItems = [
                { page: PAGES.HOME, icon: IconHome, label: 'Home' },
                { page: PAGES.CAMERA, icon: IconCamera, label: 'Camera' },
                { page: PAGES.LIBRARY, icon: IconBookOpen, label: 'Library' },
                { page: PAGES.PROFILE, icon: IconUser, label: 'Profile' },
            ];

            return (
                <footer className="fixed bottom-0 left-0 right-0 max-w-sm mx-auto bg-white border-t border-gray-200 shadow-2xl rounded-t-2xl z-20">
                    <div className="flex justify-around p-2">
                        {navItems.map(item => {
                            const isActive = currentPage === item.page;
                            return (
                                <button
                                    key={item.page}
                                    onClick={() => setCurrentPage(item.page)}
                                    className={`flex flex-col items-center p-2 rounded-xl transition duration-200 ${isActive ? 'text-green-600' : 'text-gray-500 hover:text-green-500'}`}
                                >
                                    <item.icon className={`w-6 h-6 ${isActive ? 'fill-green-100' : 'fill-none'}`} />
                                    <span className="text-xs mt-1 font-medium">{item.label}</span>
                                </button>
                            );
                        })}
                    </div>
                </footer>
            );
        };
        
        // --- Main Application Component ---
        const AppContent = () => {
            const [currentPage, setCurrentPage] = useState(PAGES.SPLASH);
            const [identificationResult, setIdentificationResult] = useState(null);

            // Use a stable, memoized version of setCurrentPage to avoid unnecessary re-renders in children
            const setPage = useCallback((page) => {
                setCurrentPage(page);
                if (page !== PAGES.RESULT) {
                    setIdentificationResult(null); // Clear result when navigating away
                }
            }, []);

            const renderPage = () => {
                switch (currentPage) {
                    case PAGES.SPLASH:
                        return <SplashPage setCurrentPage={setPage} />;
                    case PAGES.DISCLAIMER:
                        return <DisclaimerPage setCurrentPage={setPage} />;
                    case PAGES.HOME:
                        return <HomePage setCurrentPage={setPage} />;
                    case PAGES.CAMERA:
                        return <CameraPage setCurrentPage={setPage} setIdentificationResult={setIdentificationResult} />;
                    case PAGES.IDENTIFYING:
                        return <IdentifyingPage />;
                    case PAGES.RESULT:
                        return <ResultPage setCurrentPage={setPage} identificationResult={identificationResult} />;
                    case PAGES.LIBRARY:
                        return <LibraryPage setCurrentPage={setPage} />;
                    case PAGES.PROFILE:
                        return <ProfilePage />;
                    default:
                        return <HomePage setCurrentPage={setPage} />;
                }
            };
            
            const showNavBar = currentPage !== PAGES.SPLASH && currentPage !== PAGES.DISCLAIMER && currentPage !== PAGES.IDENTIFYING && currentPage !== PAGES.RESULT;
            const showHeader = currentPage !== PAGES.SPLASH && currentPage !== PAGES.CAMERA && currentPage !== PAGES.DISCLAIMER && currentPage !== PAGES.IDENTIFYING && currentPage !== PAGES.RESULT;

            return (
                <div className="app-container h-full bg-white flex flex-col overflow-hidden">
                    {showHeader && (
                        <header className="sticky top-0 bg-white p-4 border-b border-gray-200 flex items-center justify-between z-10">
                            <h1 className="text-xl font-bold text-green-700 flex items-center">
                                <IconLeaf className="w-6 h-6 mr-1" /> RootSage
                            </h1>
                            <Button
                                onClick={() => setPage(PAGES.PROFILE)}
                                variant="link"
                                className="text-sm text-gray-500 hover:text-green-600"
                            >
                                Profile
                            </Button>
                        </header>
                    )}

                    {/* Navigation buttons for pages with specific back navigation */}
                    {(currentPage === PAGES.LIBRARY || currentPage === PAGES.PROFILE) && (
                        <div className="sticky top-0 bg-white p-2 border-b border-gray-100 z-10">
                            <Button 
                                onClick={() => setPage(PAGES.HOME)}
                                variant="link"
                                icon={IconChevronLeft}
                                className="text-sm"
                            >
                                Back
                            </Button>
                        </div>
                    )}
                    
                    <main className={`flex-grow overflow-y-auto ${showNavBar ? 'mb-16' : ''} ${currentPage === PAGES.SPLASH ? 'h-screen' : 'pb-4'}`}>
                        {renderPage()}
                    </main>

                    {showNavBar && <NavBar currentPage={currentPage} setCurrentPage={setPage} />}
                </div>
            );
        };
        
        // Root Component wrapped in the Firebase Provider
        const App = () => (
            <FirebaseProvider>
                <AppContent />
            </FirebaseProvider>
        );

        // Render the application
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);

    </script>
</body>
</html>
